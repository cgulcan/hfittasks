<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Halk Faktoring | BT Portal</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #0065B3; --primary-hover: #004d8a; --primary-light: #eff6ff;
            --glass-bg: rgba(255, 255, 255, 0.75); --glass-border: rgba(255, 255, 255, 0.6);    
            --glass-shadow: 0 8px 32px 0 rgba(100, 116, 139, 0.1); --glass-blur: blur(16px);                    
            --glass-input: rgba(255, 255, 255, 0.5); --glass-btn: rgba(255, 255, 255, 0.4);       
            --text-main: #1e293b; --text-sec: #475569;
            --header-height: 65px; --bottom-nav-height: 80px;
            --todo: #f59e0b; --prog: #0065B3; --done: #10b981; --critical: #ef4444;
        }

        [data-theme="dark"] {
            --primary: #60a5fa; --primary-hover: #93c5fd;
            --glass-bg: rgba(30, 41, 59, 0.80); --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --glass-input: rgba(0, 0, 0, 0.3); --glass-btn: rgba(255, 255, 255, 0.05);
            --text-main: #f1f5f9; --text-sec: #cbd5e1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: 'Inter', sans-serif; margin: 0; padding: 0; color: var(--text-main); height: 100vh; width: 100vw; overflow: hidden; 
            background-color: #e2e8f0; 
            background-image: radial-gradient(at 0% 0%, rgba(255,255,255,0.8) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(200,220,240,0.5) 0px, transparent 50%);
            background-attachment: fixed; background-size: cover; display: flex; flex-direction: column; transition: all 0.3s ease;
        }
        [data-theme="dark"] body { background-color: #0f172a; background-image: radial-gradient(at 0% 0%, rgba(30, 58, 138, 0.3) 0px, transparent 50%); }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.6); border-radius: 4px; }

        /* HEADER */
        header { 
            height: var(--header-height); flex-shrink: 0; 
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; 
            padding: 0 25px; padding-top: env(safe-area-inset-top); z-index: 50; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }
        .brand { display: flex; align-items: center; gap: 12px; } .logo-img { height: 32px; width: auto; } .brand-text { font-weight: 800; font-size: 18px; color: var(--text-main); }
        .nav-wrapper { display: flex; align-items: center; gap: 10px; }
        .user-area { display: flex; align-items: center; gap: 10px; }
        .btn-icon { width: 38px; height: 38px; border-radius: 10px; border: 1px solid var(--glass-border); background: var(--glass-btn); color: var(--text-sec); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 9px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 101, 179, 0.2); }

        /* GLOBAL LAYOUT (GRID) */
        .layout-grid { 
            display: grid; grid-template-columns: 1fr 340px; /* Ana İçerik | Sidebar */
            height: 100%; overflow: hidden; 
        }
        
        /* MAIN CONTENT AREA */
        .main-content { 
            padding: 25px; overflow-y: auto; overflow-x: hidden; position: relative;
            display: flex; flex-direction: column;
        }
        .view-section { display: none; width: 100%; flex-direction: column; gap: 20px; }
        .view-section.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* GLOBAL SIDEBAR (RIGHT) */
        .global-sidebar {
            background: rgba(255, 255, 255, 0.4); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            padding: 20px; display: flex; flex-direction: column; gap: 20px;
            overflow-y: auto;
        }
        [data-theme="dark"] .global-sidebar { background: rgba(15, 23, 42, 0.4); }

        /* WIDGETS IN SIDEBAR */
        .side-box { 
            background: var(--glass-bg); border: 1px solid var(--glass-border); 
            border-radius: 16px; padding: 16px; box-shadow: var(--glass-shadow); 
            display: flex; flex-direction: column; 
        }
        .sb-title { font-size: 12px; font-weight: 800; color: var(--text-sec); text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.05em; }

        /* MINI CALENDAR */
        .cal-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-title { font-size: 14px; font-weight: 700; color: var(--primary); text-transform: uppercase; }
        .dc-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .dc-head { text-align: center; font-size: 10px; font-weight: 700; color: var(--text-sec); padding-bottom: 5px; }
        .dc-cell { 
            height: 36px; border-radius: 8px; border: 1px solid transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 500; cursor: pointer; position: relative; transition: 0.2s;
            background: rgba(255,255,255,0.3);
        }
        .dc-cell:hover { background: #fff; border-color: var(--primary); }
        .dc-cell.is-today { border: 1px solid var(--primary); color: var(--primary); font-weight: 800; background: #fff; }
        .dc-dots { position: absolute; bottom: 3px; display: flex; gap: 2px; }
        .dc-dot { width: 4px; height: 4px; border-radius: 50%; }

        /* VIEWS STYLES */
        /* Kanban */
        .kanban-board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; flex: 1; }
        .k-col { min-width: 280px; width: 320px; background: var(--glass-bg); border-radius: 16px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; height: 100%; }
        .k-header { padding: 15px; border-bottom: 1px solid var(--glass-border); font-weight: 700; font-size: 13px; display: flex; justify-content: space-between; }
        .k-list { padding: 10px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        /* Task Card */
        .task-card { background: rgba(255,255,255,0.6); border: 1px solid var(--glass-border); border-radius: 12px; padding: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: grab; border-left: 4px solid transparent; transition: 0.2s; }
        .task-card:hover { transform: translateY(-2px); background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .p-Yüksek { border-left-color: var(--critical); } .p-Orta { border-left-color: var(--todo); } .p-Düşük { border-left-color: var(--done); }
        .c-title { font-weight: 700; font-size: 14px; color: var(--text-main); margin-bottom: 4px; }
        .c-desc { font-size: 12px; color: var(--text-sec); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .c-meta { display: flex; justify-content: space-between; margin-top: 8px; font-size: 10px; color: var(--text-sec); font-weight: 600; }

        /* Daily View (Artık sadece Liste, Takvim Sidebar'da) */
        .daily-list-wrapper { display: flex; flex-direction: column; gap: 10px; }
        .daily-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; transition: 0.2s; cursor: pointer; }
        .daily-item:hover { transform: translateX(5px); background: #fff; }
        .di-time { font-weight: 700; color: var(--primary); font-size: 14px; width: 50px; }
        .di-content { flex: 1; } .di-title { font-weight: 700; font-size: 14px; } .di-desc { font-size: 12px; color: var(--text-sec); }

        /* List & Dashboard */
        .list-row { display: grid; grid-template-columns: 80px 2fr 1fr 100px 100px; padding: 15px; border-bottom: 1px solid var(--glass-border); align-items: center; font-size: 13px; background: var(--glass-bg); margin-bottom: 5px; border-radius: 8px; cursor: pointer; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .stat-box { background: var(--glass-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center; }
        .stat-val { font-size: 32px; font-weight: 800; color: var(--text-main); } .stat-lbl { font-size: 12px; color: var(--text-sec); text-transform: uppercase; font-weight: 700; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); } .modal.show { display: flex; }
        .modal-box { width: 500px; background: var(--glass-bg); backdrop-filter: blur(25px); border-radius: 20px; border: 1px solid var(--glass-border); padding: 25px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .f-input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass-input); font-family: inherit; }
        
        .mobile-only, .bottom-nav { display: none; }

        /* --- MOBİL UYUMLULUK --- */
        @media (max-width: 768px) {
            .layout-grid { grid-template-columns: 1fr; display: flex; flex-direction: column; }
            .nav-wrapper { display: none; } .user-info { display: none; } .mobile-only { display: flex; }
            
            /* Sidebar Mobilde İçeriğin Altına İner */
            .global-sidebar { 
                order: 2; /* İçerikten sonra */
                padding: 15px; border-left: none; border-top: 1px solid var(--glass-border); 
                background: rgba(255,255,255,0.5);
                flex: 0 0 auto; /* Yüksekliği içeriğe göre */
            }
            .main-content { order: 1; padding: 15px; padding-bottom: 0; flex: 1; overflow-y: auto; }
            
            /* Kanban Mobilde */
            .kanban-board { scroll-snap-type: x mandatory; padding-right: 15px; } .k-col { min-width: 85vw; scroll-snap-align: center; }
            
            /* Dashboard Mobilde */
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .list-row { grid-template-columns: 1fr; display: flex; flex-direction: column; gap: 5px; }

            /* Bottom Nav */
            .bottom-nav { 
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: calc(70px + env(safe-area-inset-bottom));
                background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border);
                justify-content: space-around; align-items: flex-start; padding-top: 10px; z-index: 100;
            }
            .bn-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); background: none; border: none; font-size: 10px; gap: 4px; }
            .bn-item.active { color: var(--primary); font-weight: 700; }
            
            /* İçerik padding (Navbar için) */
            body { padding-bottom: 80px; }
            .layout-grid { height: calc(100vh - 80px); }
        }
    </style>
</head>
<body onload="initApp()">

<div id="toastContainer" style="position:fixed; top:20px; right:20px; z-index:3000;"></div>

<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#e2e8f0; z-index:2000; display:flex; align-items:center; justify-content:center;">
    <div style="background:rgba(255,255,255,0.6); padding:40px; border-radius:20px; text-align:center; backdrop-filter:blur(20px); width:90%; max-width:350px;">
        <img src="logo.png" style="width:80px; margin-bottom:20px;">
        <h2 style="margin:0 0 10px 0; color:var(--primary);">BT Portal</h2>
        <input type="email" id="email" class="f-input" placeholder="E-posta">
        <input type="password" id="password" class="f-input" placeholder="Şifre">
        <button class="btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="login()">Giriş Yap</button>
        <div id="loginError" style="color:red; margin-top:10px; font-size:12px;"></div>
    </div>
</div>

<div id="appContainer">
    <header>
        <div class="brand"><img src="logo.png" class="logo-img"><span class="brand-text">BT YÖNETİM</span></div>
        <div class="nav-wrapper">
            <div class="nav-pills">
                <button class="nav-btn active" onclick="showView('daily', this)">Günlük</button>
                <button class="nav-btn" onclick="showView('kanban', this)">Pano</button>
                <button class="nav-btn" onclick="showView('week', this)">Liste</button>
                <button class="nav-btn" onclick="showView('dashboard', this)">Rapor</button>
            </div>
        </div>
        <div class="user-area">
            <button class="btn-icon" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
            <div class="user-info" id="displayUserName">Kullanıcı</div>
            <button class="btn-icon" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
            <button class="btn-primary" onclick="newTask()">+ Yeni</button>
        </div>
    </header>

    <div class="layout-grid">
        
        <div class="main-content">
            <div id="view-daily" class="view-section active">
                <h2 class="sb-title" style="font-size:18px; color:var(--text-main);">Bugünkü Görevler (<span id="dailyCount">0</span>)</h2>
                <div class="daily-list-wrapper" id="dailyTaskList"></div>
            </div>

            <div id="view-kanban" class="view-section">
                <div class="kanban-board">
                    <div class="k-col"><div class="k-header">BEKLEYEN <span id="cnt-todo">0</span></div><div class="k-list" id="lst-todo" data-status="todo"></div></div>
                    <div class="k-col"><div class="k-header" style="color:var(--prog)">İŞLEMDE <span id="cnt-progress">0</span></div><div class="k-list" id="lst-progress" data-status="progress"></div></div>
                    <div class="k-col"><div class="k-header" style="color:var(--done)">BİTEN <span id="cnt-done">0</span></div><div class="k-list" id="lst-done" data-status="done"></div></div>
                </div>
            </div>

            <div id="view-week" class="view-section">
                <div class="list-body" id="agendaList"></div>
            </div>

            <div id="view-dashboard" class="view-section">
                <div class="stats-grid">
                    <div class="stat-box"><span class="stat-lbl">Toplam</span><span class="stat-val" id="dTotal">0</span></div>
                    <div class="stat-box"><span class="stat-lbl" style="color:var(--todo)">Bekleyen</span><span class="stat-val" id="dTodo">0</span></div>
                    <div class="stat-box"><span class="stat-lbl" style="color:var(--prog)">İşlemde</span><span class="stat-val" id="dProg">0</span></div>
                    <div class="stat-box"><span class="stat-lbl" style="color:var(--done)">Biten</span><span class="stat-val" id="dDone">0</span></div>
                </div>
                <div style="height:300px; background:var(--glass-bg); padding:10px; border-radius:16px; margin-top:20px;"><canvas id="chartStatus"></canvas></div>
            </div>
        </div>

        <aside class="global-sidebar">
            <div class="side-box">
                <div class="cal-controls">
                    <button class="btn-icon" style="width:24px; height:24px;" onclick="navMiniMonth(-1)"><i class="fa-solid fa-chevron-left" style="font-size:10px;"></i></button>
                    <span class="cal-title" id="miniCalTitle"></span>
                    <button class="btn-icon" style="width:24px; height:24px;" onclick="navMiniMonth(1)"><i class="fa-solid fa-chevron-right" style="font-size:10px;"></i></button>
                </div>
                <div class="dc-grid">
                    <div class="dc-head">Pt</div><div class="dc-head">Sa</div><div class="dc-head">Çr</div><div class="dc-head">Pr</div><div class="dc-head">Cm</div><div class="dc-head" style="color:#ef4444">Ct</div><div class="dc-head" style="color:#ef4444">Pz</div>
                </div>
                <div class="dc-grid" id="miniCalGrid"></div>
            </div>

            <div style="flex:1;">
                <div class="sb-title">Son Aktiviteler</div>
                <div id="sideFeedList" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </aside>

    </div>

    <div class="bottom-nav">
        <button class="bn-item active" onclick="showView('daily', this)"><i class="fa-solid fa-calendar-day"></i><span>Günlük</span></button>
        <button class="bn-item" onclick="showView('kanban', this)"><i class="fa-solid fa-columns"></i><span>Pano</span></button>
        <button class="bn-item" onclick="newTask()" style="color:var(--primary)"><i class="fa-solid fa-plus-circle" style="font-size:32px;"></i></button>
        <button class="bn-item" onclick="showView('week', this)"><i class="fa-solid fa-list-ul"></i><span>Liste</span></button>
        <button class="bn-item" onclick="showView('dashboard', this)"><i class="fa-solid fa-chart-pie"></i><span>Rapor</span></button>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-box">
        <h3 style="margin-bottom:20px;">Görev Detayı <span onclick="closeModal()" style="float:right; cursor:pointer;">✕</span></h3>
        <input type="hidden" id="tId">
        <label style="font-size:12px; font-weight:700;">Konu</label>
        <select id="tTitle" class="f-input"></select>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label style="font-size:12px; font-weight:700;">Durum</label><select id="tStatus" class="f-input"><option value="todo">Bekliyor</option><option value="progress">İşlemde</option><option value="done">Tamamlandı</option></select></div>
            <div><label style="font-size:12px; font-weight:700;">Öncelik</label><select id="tPriority" class="f-input"><option value="Düşük">Düşük</option><option value="Orta">Orta</option><option value="Yüksek">Yüksek</option></select></div>
        </div>
        <label style="font-size:12px; font-weight:700;">Bitiş Tarihi</label>
        <input type="date" id="tDate" class="f-input">
        <label style="font-size:12px; font-weight:700;">Açıklama</label>
        <textarea id="tDesc" class="f-input" rows="3"></textarea>
        <div style="display:flex; justify-content:space-between; margin-top:10px;">
            <button class="btn-icon" style="border-color:#ef4444; color:#ef4444;" onclick="delTask()"><i class="fa-solid fa-trash"></i></button>
            <button class="btn-primary" onclick="saveTask()">Kaydet</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, runTransaction, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    window.toggleTheme = function() {
        const body = document.body; const current = body.getAttribute('data-theme'); const next = current === 'dark' ? 'light' : 'dark';
        if (next === 'light') body.removeAttribute('data-theme'); else body.setAttribute('data-theme', 'dark');
        if(window.chartStatusInst) renderDashboard(window.allTasks);
    }

    const firebaseConfig = { apiKey: "AIzaSyAvPpg1Qa6XF8kPV_VZXq7BE04geXLqo4s", authDomain: "it-tasks-bc974.firebaseapp.com", projectId: "it-tasks-bc974", storageBucket: "it-tasks-bc974.firebasestorage.app", messagingSenderId: "978679373454", appId: "1:978679373454:web:3ee1c689cf1ca321af33df" };
    let app, db, auth; try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) {}

    const TOPICS = ["Infact", "Rating", "Dijital Mizan", "KDS", "Mobil Uygulama", "Kullanıcı Talepleri", "Satın Alım", "Diğer"];
    window.allTasks = []; let miniCalDate = new Date();

    window.initApp = () => {
        const sel = document.getElementById('tTitle'); TOPICS.forEach(t => sel.innerHTML += `<option>${t}</option>`);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('displayUserName').innerText = user.email.split('@')[0];
                listenTasks();
                if(window.innerWidth > 768) initSortable();
            } else { document.getElementById('loginOverlay').style.display = 'flex'; }
        });
    }

    window.login = () => { const e = document.getElementById('email').value; const p = document.getElementById('password').value; signInWithEmailAndPassword(auth, e, p).catch(err => { if(err.code === 'auth/user-not-found') createUserWithEmailAndPassword(auth, e, p); else alert(err.message); }); }
    window.logout = () => signOut(auth).then(()=>window.location.reload());

    function listenTasks() {
        if(!db) return;
        onSnapshot(query(collection(db, "tasks"), orderBy("code", "desc")), (snap) => {
            window.allTasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAll();
        });
    }

    function renderAll() {
        let tasks = window.allTasks;
        // Global Calendar Render
        renderMiniCalendar(tasks);
        renderSideFeed(tasks);
        
        // Active View Render
        const view = document.querySelector('.view-section.active').id;
        if(view === 'view-daily') renderDaily(tasks);
        else if(view === 'view-kanban') renderKanban(tasks);
        else if(view === 'view-week') renderList(tasks);
        else renderDashboard(tasks);
    }

    // --- GLOBAL CALENDAR LOGIC ---
    function renderMiniCalendar(tasks) {
        const y = miniCalDate.getFullYear(), m = miniCalDate.getMonth(); const now = new Date();
        document.getElementById('miniCalTitle').innerText = miniCalDate.toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
        const g = document.getElementById('miniCalGrid'); g.innerHTML = '';
        const offset = (new Date(y, m, 1).getDay() + 6) % 7; 
        const daysInMonth = new Date(y, m+1, 0).getDate(); 
        for(let i=0; i<offset; i++) g.innerHTML += '<div></div>';
        for(let i=1; i<=daysInMonth; i++) {
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dayTasks = tasks.filter(t => t.date === dStr && t.status !== 'done');
            let dots = ''; dayTasks.forEach(t => { let c = t.priority==='Yüksek'?'#ef4444':(t.priority==='Orta'?'#f59e0b':'#10b981'); dots+=`<div class="dc-dot" style="background:${c}"></div>`; });
            const isToday = (y===now.getFullYear() && m===now.getMonth() && i===now.getDate());
            g.innerHTML += `<div class="dc-cell ${isToday?'is-today':''}">${i}<div class="dc-dots">${dots}</div></div>`;
        }
    }
    window.navMiniMonth = (d) => { miniCalDate.setMonth(miniCalDate.getMonth()+d); renderAll(); }

    function renderSideFeed(tasks) {
        const list = document.getElementById('sideFeedList'); list.innerHTML = '';
        tasks.slice(0,5).forEach(t => list.innerHTML += `<div class="task-card" onclick="openModal('${t.id}')"><div class="c-title">${t.title}</div><div class="c-desc">${t.status}</div></div>`);
    }

    // --- VIEW SPECIFIC RENDERS ---
    function renderDaily(tasks) {
        const todayStr = new Date().toISOString().split('T')[0];
        const dailyTasks = tasks.filter(t => t.date === todayStr);
        document.getElementById('dailyCount').innerText = dailyTasks.length;
        const l = document.getElementById('dailyTaskList'); l.innerHTML = '';
        dailyTasks.forEach(t => l.innerHTML += `<div class="daily-item" onclick="openModal('${t.id}')"><div class="di-time">${t.date.split('-')[2]}</div><div class="di-content"><div class="di-title">${t.title}</div><div class="di-desc">${t.priority}</div></div></div>`);
    }

    function renderKanban(tasks) {
        const cols = { todo: document.getElementById('lst-todo'), progress: document.getElementById('lst-progress'), done: document.getElementById('lst-done') };
        Object.values(cols).forEach(c => c.innerHTML='');
        tasks.forEach(t => {
            if(cols[t.status]) cols[t.status].innerHTML += `<div class="task-card p-${t.priority}" onclick="openModal('${t.id}')"><div class="c-title">${t.title}</div><div class="c-desc">${t.code}</div></div>`;
        });
        // Counts update removed for brevity
    }

    function renderList(tasks) {
        const l = document.getElementById('agendaList'); l.innerHTML = '';
        tasks.forEach(t => l.innerHTML += `<div class="list-row" onclick="openModal('${t.id}')"><div>${t.code}</div><div>${t.title}</div><div>${t.status}</div><div>${t.date}</div></div>`);
    }

    function renderDashboard(tasks) {
        // Simple counts
        const c = {todo:0, progress:0, done:0}; tasks.forEach(t=> {if(c[t.status]!==undefined)c[t.status]++});
        document.getElementById('dTotal').innerText = tasks.length; document.getElementById('dTodo').innerText = c.todo;
        document.getElementById('dProg').innerText = c.progress; document.getElementById('dDone').innerText = c.done;
        if(window.chartStatusInst) window.chartStatusInst.destroy();
        window.chartStatusInst = new Chart(document.getElementById('chartStatus'), {type:'doughnut', data:{labels:['Bekleyen','İşlemde','Biten'], datasets:[{data:[c.todo,c.progress,c.done], backgroundColor:['#f59e0b','#0065B3','#10b981']}]}});
    }

    // --- ACTIONS ---
    window.showView = (v, btn) => {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.nav-btn, .bn-item').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active');
        renderAll();
    }
    
    window.newTask = () => { document.getElementById('tId').value=''; document.getElementById('tTitle').value=''; document.getElementById('modal').classList.add('show'); }
    window.closeModal = () => { document.getElementById('modal').classList.remove('show'); }
    window.openModal = (id) => { 
        const t = window.allTasks.find(x=>x.id===id); if(t) { document.getElementById('tId').value=t.id; document.getElementById('tTitle').value=t.title; document.getElementById('tStatus').value=t.status; document.getElementById('tDate').value=t.date; document.getElementById('modal').classList.add('show'); }
    }
    
    window.saveTask = async () => {
        const id = document.getElementById('tId').value;
        const d = { title:document.getElementById('tTitle').value, status:document.getElementById('tStatus').value, priority:document.getElementById('tPriority').value, date:document.getElementById('tDate').value, desc:document.getElementById('tDesc').value };
        if(id) await updateDoc(doc(db,"tasks",id), d);
        else { 
            await runTransaction(db, async(t)=>{ 
                const ref = doc(db,"meta","counters"); const snap = await t.get(ref); const seq = (snap.exists()?snap.data().taskSeq:0)+1; 
                t.set(ref,{taskSeq:seq},{merge:true}); d.code='GRV-'+seq; await addDoc(collection(db,"tasks"), d);
            });
        }
        closeModal();
    }
    window.delTask = async () => { if(confirm('Sil?')) { await deleteDoc(doc(db,"tasks", document.getElementById('tId').value)); closeModal(); } }

    function initSortable() {
        ['lst-todo', 'lst-progress', 'lst-done'].forEach(id => new Sortable(document.getElementById(id), { group:'s', onEnd: async(evt)=>{ if(evt.to!==evt.from) await updateDoc(doc(db,"tasks",evt.item.getAttribute('data-id')), {status:evt.to.getAttribute('data-status')}); } }));
    }
</script>
</body>
</html>
