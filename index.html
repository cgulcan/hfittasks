<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>Halk Faktoring | BT Yönetim</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            /* TEKNOLOJİK KURUMSAL PALET */
            --bg-app: #f1f5f9;          /* Uygulama Arka Planı */
            --bg-sidebar: #0f172a;      /* Koyu Sidebar */
            --bg-panel: #ffffff;        /* Panel Arka Planı */
            
            --primary: #2563eb;         /* Elektrik Mavisi */
            --primary-dark: #1d4ed8;
            --primary-glow: rgba(37, 99, 235, 0.15);
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            --text-invert: #f8fafc;
            
            --border: #e2e8f0;
            --border-focus: #94a3b8;
            
            /* Durum Renkleri (Hafif Neon Etkisi) */
            --st-todo: #f59e0b; 
            --st-prog: #3b82f6; 
            --st-done: #10b981; 
            --st-crit: #ef4444;

            --radius-md: 8px;
            --radius-lg: 12px;
            
            --header-h: 60px;
            --sidebar-w: 260px; /* Varsayılan genişlik */
        }

        [data-theme="dark"] {
            --bg-app: #020617;
            --bg-sidebar: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --border-focus: #475569;
        }

        /* --- TEMEL YAPILANDIRMA --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            margin: 0; padding: 0; font-family: 'Inter', sans-serif; 
            background: var(--bg-app); color: var(--text-main); 
            height: 100vh; width: 100vw; overflow: hidden; /* Taşmayı engelle */
            display: flex; flex-direction: column;
        }

        /* --- RESIZABLE (GENİŞLETİLEBİLİR) ALAN MANTIĞI --- */
        .app-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* Sidebar (Soldaki Menü) */
        .sidebar {
            width: var(--sidebar-w); min-width: 60px; max-width: 400px;
            background: var(--bg-sidebar); color: var(--text-muted);
            display: flex; flex-direction: column; z-index: 20;
            border-right: 1px solid var(--border);
            transition: width 0.05s ease; /* Resizing sırasında akıcı olsun */
        }
        
        /* Ana İçerik Alanı */
        .main-content {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            background: var(--bg-app); position: relative; min-width: 320px;
        }

        /* RESIZER (Ayırıcı Çubuk) */
        .resizer-x {
            width: 4px; cursor: col-resize; background: transparent; z-index: 30;
            transition: background 0.2s; position: relative;
        }
        .resizer-x:hover, .resizer-x.resizing { background: var(--primary); }
        /* Tutamaç görseli */
        .resizer-x::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            height: 20px; width: 2px; background: var(--text-muted); border-radius: 2px; opacity: 0.5;
        }

        /* --- SIDEBAR İÇERİĞİ --- */
        .brand { 
            height: var(--header-h); display: flex; align-items: center; padding: 0 20px; 
            color: var(--text-invert); font-weight: 700; font-size: 16px; letter-spacing: -0.02em;
            border-bottom: 1px solid rgba(255,255,255,0.1); gap: 12px;
        }
        .brand i { color: var(--primary); font-size: 20px; }
        
        .nav-menu { flex: 1; overflow-y: auto; padding: 20px 10px; display: flex; flex-direction: column; gap: 4px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: var(--radius-md); cursor: pointer; transition: 0.2s;
            color: var(--text-muted); font-size: 14px; font-weight: 500;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-invert); }
        .nav-item.active { 
            background: var(--primary); color: #fff; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); 
        }
        
        .user-panel { 
            padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); 
            display: flex; align-items: center; gap: 10px;
        }
        .u-avatar { width: 32px; height: 32px; background: var(--primary-dark); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }

        /* --- TOP HEADER --- */
        .topbar {
            height: var(--header-h); background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
            flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .page-info h1 { margin: 0; font-size: 18px; font-weight: 700; color: var(--text-main); }
        .page-info p { margin: 0; font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        
        .actions { display: flex; gap: 10px; }
        .btn-icon { width: 36px; height: 36px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-panel); color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-icon:hover { border-color: var(--primary); color: var(--primary); }
        .btn-action { 
            background: var(--primary); color: #fff; border: none; padding: 0 20px; 
            border-radius: 8px; height: 36px; font-size: 13px; font-weight: 600; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 5px rgba(37, 99, 235, 0.2);
        }
        .btn-action:hover { background: var(--primary-dark); transform: translateY(-1px); }

        /* --- VIEW CONTAINER --- */
        .view-port { flex: 1; overflow: hidden; position: relative; }
        .view-section { 
            position: absolute; inset: 0; padding: 20px; 
            display: none; flex-direction: column; overflow-y: auto; overflow-x: hidden;
        }
        .view-section.active { display: flex; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 1. GÜNLÜK SAYFA (SPLIT VIEW) --- */
        .daily-split { 
            display: flex; height: 100%; gap: 0; /* Gap 0 çünkü araya resizer girecek */
            border: 1px solid var(--border); border-radius: var(--radius-lg); 
            background: var(--bg-panel); overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        
        /* Sol Panel: Takvim (Resizable) */
        .daily-left { 
            width: 320px; min-width: 250px; background: var(--bg-panel); 
            display: flex; flex-direction: column; padding: 20px; 
        }
        /* Orta Ayırıcı */
        .daily-resizer { 
            width: 5px; background: var(--bg-app); cursor: col-resize; 
            border-left: 1px solid var(--border); border-right: 1px solid var(--border);
            transition: background 0.2s; position: relative; z-index: 10;
        }
        .daily-resizer:hover { background: var(--primary); }
        
        /* Sağ Panel: Görev Listesi */
        .daily-right { flex: 1; padding: 20px; display: flex; flex-direction: column; min-width: 300px; background: #fafafa; }
        [data-theme="dark"] .daily-right { background: #161e2e; }

        /* Takvim Stilleri */
        .cal-head-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
        .ch-cell { text-align: center; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; flex: 1; align-content: start; }
        .c-day { 
            aspect-ratio: 1; border-radius: 6px; border: 1px solid transparent; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 500; cursor: pointer; position: relative; transition: 0.1s;
        }
        .c-day:hover { background: var(--bg-app); border-color: var(--border); }
        .c-day.today { background: var(--primary-glow); color: var(--primary); font-weight: 700; border: 1px solid var(--primary); }
        .c-day.selected { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
        .dot-indicators { display: flex; gap: 2px; position: absolute; bottom: 4px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }

        /* Günlük Liste Kartları */
        .d-task-item {
            display: flex; gap: 15px; padding: 16px; background: var(--bg-panel); 
            border: 1px solid var(--border); border-radius: var(--radius-md); 
            margin-bottom: 10px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
        }
        .d-task-item:hover { transform: translateX(3px); border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .d-time { font-weight: 700; color: var(--text-muted); font-size: 13px; min-width: 45px; }
        .d-info h4 { margin: 0; font-size: 14px; font-weight: 600; color: var(--text-main); }
        .d-info p { margin: 0; font-size: 12px; color: var(--text-muted); margin-top: 3px; }
        .d-status-line { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }

        /* --- 2. PANO (KANBAN) --- */
        .kanban-wrapper { 
            display: flex; height: 100%; gap: 20px; overflow-x: auto; 
            padding-bottom: 10px; 
        }
        .k-col { 
            min-width: 300px; width: 320px; display: flex; flex-direction: column; 
            background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-lg); 
            height: 100%; 
        }
        .k-head { 
            padding: 16px; border-bottom: 1px solid var(--border); font-size: 12px; 
            font-weight: 800; color: var(--text-muted); letter-spacing: 0.05em; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .k-body { padding: 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        
        .k-card { 
            background: var(--bg-app); padding: 16px; border-radius: 8px; 
            border: 1px solid var(--border); cursor: grab; transition: 0.2s; 
            position: relative; overflow: hidden;
        }
        .k-card:hover { background: var(--bg-panel); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: var(--primary); }
        .k-tag { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.05); color: var(--text-muted); display: inline-block; margin-bottom: 6px; }
        
        /* --- 3. RAPOR (DASHBOARD) --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-box { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; display: flex; align-items: center; gap: 15px; }
        .sb-icon { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .sb-info div:first-child { font-size: 24px; font-weight: 800; color: var(--text-main); line-height: 1; }
        .sb-info div:last-child { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-top: 4px; }

        /* --- 4. LISTE --- */
        .list-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .list-table th { text-align: left; padding: 12px; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); }
        .list-table td { padding: 12px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        .list-row:hover td { background: var(--bg-app); cursor: pointer; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.2s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-card { background: var(--bg-panel); width: 500px; max-height: 90vh; border-radius: var(--radius-lg); display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.95); transition: 0.2s; }
        .modal-overlay.open .modal-card { transform: scale(1); }
        .m-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 16px; }
        .m-body { padding: 20px; overflow-y: auto; }
        .inp-row { margin-bottom: 16px; }
        .inp-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
        .inp-field { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); font-family: inherit; font-size: 14px; }
        .inp-field:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
        .m-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; }

        /* --- MOBİL TAB BAR (SADECE MOBİLDE) --- */
        .mobile-nav { 
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
            background: var(--bg-panel); border-top: 1px solid var(--border); z-index: 100;
            padding-bottom: env(safe-area-inset-bottom); justify-content: space-around; align-items: center;
        }
        .m-nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); font-size: 10px; font-weight: 600; border: none; background: none; }
        .m-nav-item.active { color: var(--primary); }
        .m-nav-item i { font-size: 20px; }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        @media (max-width: 768px) {
            /* Mobil Düzeni */
            .app-container { flex-direction: column; }
            .sidebar { display: none; } /* Masaüstü menüyü gizle */
            .mobile-nav { display: flex; } /* Mobil menüyü aç */
            .main-content { padding-bottom: calc(var(--bottom-nav-height) + 10px); }
            
            /* Günlük Sayfa Mobilde Alt Alta */
            .daily-split { flex-direction: column; border: none; background: transparent; box-shadow: none; overflow: visible; }
            .daily-left { width: 100%; padding: 0; margin-bottom: 20px; background: transparent; }
            .daily-right { width: 100%; padding: 0; background: transparent; }
            .daily-resizer { display: none; } /* Ayırıcıya mobilde gerek yok */
            .calendar-widget { box-shadow: var(--shadow-sm); }
            
            /* Pano Mobilde Yatay Kaydırma */
            .kanban-wrapper { padding-right: 20px; scroll-snap-type: x mandatory; }
            .k-col { min-width: 85vw; scroll-snap-align: center; }
            
            /* Dashboard Mobilde */
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            
            /* Modal Bottom Sheet */
            .modal-overlay { align-items: flex-end; }
            .modal-card { width: 100%; border-radius: 20px 20px 0 0; max-height: 85vh; }
        }
    </style>
</head>
<body onload="initApp()">

<div id="loginScreen" style="position:fixed; inset:0; background:var(--bg-app); z-index:5000; display:flex; align-items:center; justify-content:center;">
    <div style="width:320px; background:var(--bg-panel); padding:30px; border-radius:16px; border:1px solid var(--border); text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
        <img src="logo.png" style="width:50px; margin-bottom:15px;">
        <h2 style="margin:0 0 5px 0; color:var(--text-main);">Hoş Geldiniz</h2>
        <p style="color:var(--text-muted); font-size:13px; margin-bottom:20px;">BT Yönetim Paneli</p>
        <input type="email" id="email" class="inp-field" placeholder="E-posta" style="margin-bottom:10px;">
        <input type="password" id="password" class="inp-field" placeholder="Şifre" style="margin-bottom:20px;">
        <button class="btn-action" style="width:100%; justify-content:center; height:44px;" onclick="login()">Giriş Yap</button>
        <p id="loginError" style="color:var(--st-crit); font-size:12px; margin-top:10px;"></p>
    </div>
</div>

<div class="app-container">
    
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fa-solid fa-layer-group"></i> <span>BT PORTAL</span>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="showView('dashboard')"><i class="fa-solid fa-chart-pie"></i> Özet Rapor</div>
            <div class="nav-item" onclick="showView('daily')"><i class="fa-solid fa-calendar-check"></i> Günlük Plan</div>
            <div class="nav-item" onclick="showView('kanban')"><i class="fa-solid fa-columns"></i> İş Panosu</div>
            <div class="nav-item" onclick="showView('list')"><i class="fa-solid fa-list-ul"></i> Tüm Liste</div>
        </div>
        <div class="user-panel">
            <div class="u-avatar">CK</div>
            <div style="flex:1; overflow:hidden;">
                <div style="font-weight:600; font-size:13px;" id="uName">Kullanıcı</div>
                <div style="font-size:11px; color:var(--text-muted);">Yönetici</div>
            </div>
            <i class="fa-solid fa-right-from-bracket" style="cursor:pointer;" onclick="logout()"></i>
        </div>
        <div class="resizer-x" id="sidebarResizer" style="position:absolute; right:0; top:0; bottom:0; width:4px; cursor:col-resize;"></div>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <div class="page-info">
                <h1 id="pageTitle">Özet Rapor</h1>
                <p id="todayDate">Yükleniyor...</p>
            </div>
            <div class="actions">
                <button class="btn-icon" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
                <button class="btn-action" onclick="newTask()"><i class="fa-solid fa-plus"></i> <span style="display:none; display:md-block;">Yeni İş</span></button>
            </div>
        </header>

        <div class="view-port">
            
            <div id="view-dashboard" class="view-section active">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="sb-icon" style="background:#eff6ff; color:#2563eb;"><i class="fa-solid fa-list"></i></div>
                        <div class="sb-info"><div id="dTotal">0</div><div>Toplam</div></div>
                    </div>
                    <div class="stat-box">
                        <div class="sb-icon" style="background:#fff7ed; color:#ea580c;"><i class="fa-solid fa-clock"></i></div>
                        <div class="sb-info"><div id="dTodo">0</div><div>Bekleyen</div></div>
                    </div>
                    <div class="stat-box">
                        <div class="sb-icon" style="background:#eef2ff; color:#4f46e5;"><i class="fa-solid fa-spinner"></i></div>
                        <div class="sb-info"><div id="dProg">0</div><div>İşlemde</div></div>
                    </div>
                    <div class="stat-box">
                        <div class="sb-icon" style="background:#f0fdf4; color:#16a34a;"><i class="fa-solid fa-check"></i></div>
                        <div class="sb-info"><div id="dDone">0</div><div>Biten</div></div>
                    </div>
                </div>
                <div style="background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; padding:20px; height:300px;">
                    <h3 style="margin:0 0 15px 0; font-size:14px;">İş Yükü Dağılımı</h3>
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>

            <div id="view-daily" class="view-section">
                <div class="daily-split" id="dailySplit">
                    <div class="daily-left" id="dailyLeft">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <button class="btn-icon" style="width:28px; height:28px;" onclick="navCal(-1)"><i class="fa-solid fa-chevron-left" style="font-size:12px;"></i></button>
                            <span style="font-weight:700; font-size:14px;" id="calTitle">Ay Yıl</span>
                            <button class="btn-icon" style="width:28px; height:28px;" onclick="navCal(1)"><i class="fa-solid fa-chevron-right" style="font-size:12px;"></i></button>
                        </div>
                        <div class="cal-head-row">
                            <div class="ch-cell">Pt</div><div class="ch-cell">Sa</div><div class="ch-cell">Ça</div><div class="ch-cell">Pe</div><div class="ch-cell">Cu</div><div class="ch-cell" style="color:var(--st-crit)">Ct</div><div class="ch-cell" style="color:var(--st-crit)">Pz</div>
                        </div>
                        <div class="cal-grid" id="calendarGrid"></div>
                    </div>
                    
                    <div class="daily-resizer" id="dailyResizer"></div>

                    <div class="daily-right" id="dailyRight">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <div>
                                <h2 style="margin:0; font-size:18px;">Seçili Tarih</h2>
                                <p style="margin:0; font-size:12px; color:var(--text-muted);" id="selDateDisp">Bugün</p>
                            </div>
                            <button class="btn-action" style="padding:0 12px; height:32px;" onclick="newTaskForDate()">+ Ekle</button>
                        </div>
                        <div style="flex:1; overflow-y:auto;" id="dayTaskList"></div>
                    </div>
                </div>
            </div>

            <div id="view-kanban" class="view-section">
                <div class="kanban-wrapper">
                    <div class="k-col">
                        <div class="k-head">BEKLEYEN <span id="k-todo-c">0</span></div>
                        <div class="k-body" id="col-todo" data-status="todo"></div>
                    </div>
                    <div class="k-col">
                        <div class="k-head" style="color:var(--st-prog)">İŞLEMDE <span id="k-prog-c">0</span></div>
                        <div class="k-body" id="col-progress" data-status="progress"></div>
                    </div>
                    <div class="k-col">
                        <div class="k-head" style="color:var(--st-done)">BİTEN <span id="k-done-c">0</span></div>
                        <div class="k-body" id="col-done" data-status="done"></div>
                    </div>
                </div>
            </div>

            <div id="view-list" class="view-section">
                <div style="background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; overflow:hidden;">
                    <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; gap:10px;">
                        <input type="text" id="searchInp" class="inp-field" placeholder="Ara..." onkeyup="renderList()" style="width:200px;">
                        <select id="filterStat" class="inp-field" onchange="renderList()" style="width:120px;"><option value="all">Tümü</option><option value="todo">Bekleyen</option><option value="done">Biten</option></select>
                        <button class="btn-icon" onclick="exportExcel()" style="margin-left:auto;"><i class="fa-solid fa-download"></i></button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="list-table">
                            <thead><tr style="text-align:left; background:var(--bg-app);"><th style="padding:12px;">Kod</th><th>Konu</th><th>Tarih</th><th>Durum</th></tr></thead>
                            <tbody id="fullListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<div class="mobile-nav">
    <button class="m-nav-item active" onclick="showView('dashboard', this)"><i class="fa-solid fa-chart-pie"></i><span>Özet</span></button>
    <button class="m-nav-item" onclick="showView('daily', this)"><i class="fa-solid fa-calendar-day"></i><span>Günlük</span></button>
    <button class="m-nav-item" onclick="newTask()" style="color:var(--primary)"><i class="fa-solid fa-circle-plus" style="font-size:32px;"></i></button>
    <button class="m-nav-item" onclick="showView('kanban', this)"><i class="fa-solid fa-columns"></i><span>Pano</span></button>
    <button class="m-nav-item" onclick="showView('list', this)"><i class="fa-solid fa-list"></i><span>Liste</span></button>
</div>

<div id="modal" class="modal-overlay">
    <div class="modal-card">
        <div class="m-header"><span>Görev Detayı</span><i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeModal()"></i></div>
        <div class="m-body">
            <input type="hidden" id="tId">
            <div class="inp-row"><label class="inp-label">Konu</label><select id="tTitle" class="inp-field"></select></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="inp-row"><label class="inp-label">Durum</label><select id="tStatus" class="inp-field"><option value="todo">Bekliyor</option><option value="progress">İşlemde</option><option value="done">Tamamlandı</option></select></div>
                <div class="inp-row"><label class="inp-label">Öncelik</label><select id="tPriority" class="inp-field"><option value="Düşük">Düşük</option><option value="Orta">Orta</option><option value="Yüksek">Yüksek</option></select></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="inp-row"><label class="inp-label">Tarih</label><input type="date" id="tDate" class="inp-field"></div>
                <div class="inp-row"><label class="inp-label">Saat</label><input type="time" id="tTime" class="inp-field"></div>
            </div>
            <div class="inp-row"><label class="inp-label">Açıklama</label><textarea id="tDesc" class="inp-field" rows="3"></textarea></div>
        </div>
        <div class="m-footer">
            <button class="btn-icon" style="border-color:var(--st-crit); color:var(--st-crit);" onclick="delTask()"><i class="fa-solid fa-trash"></i></button>
            <button class="btn-action" onclick="saveTask()">Kaydet</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, runTransaction, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAvPpg1Qa6XF8kPV_VZXq7BE04geXLqo4s", authDomain: "it-tasks-bc974.firebaseapp.com", projectId: "it-tasks-bc974", storageBucket: "it-tasks-bc974.firebasestorage.app", messagingSenderId: "978679373454", appId: "1:978679373454:web:3ee1c689cf1ca321af33df" };
    let app, db, auth; try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) {}

    const TOPICS = ["Infact", "Rating", "Dijital Mizan", "KDS", "Mobil Uygulama", "Kullanıcı Talepleri", "Satın Alım", "RM/KKB", "Halkbank", "Denetim", "Diğer"];
    let tasks = []; let calDate = new Date(); let activeDate = new Date();

    // --- RESIZABLE LOGIC ---
    // 1. Sidebar Resizer
    const sbResizer = document.getElementById('sidebarResizer');
    const sidebar = document.getElementById('sidebar');
    let isResizingSb = false;

    sbResizer.addEventListener('mousedown', (e) => {
        isResizingSb = true; document.body.style.cursor = 'col-resize';
    });

    // 2. Daily View Resizer
    const dResizer = document.getElementById('dailyResizer');
    const dLeft = document.getElementById('dailyLeft');
    let isResizingD = false;

    if(dResizer) {
        dResizer.addEventListener('mousedown', (e) => {
            isResizingD = true; document.body.style.cursor = 'col-resize';
        });
    }

    document.addEventListener('mousemove', (e) => {
        if (isResizingSb) {
            let newW = e.clientX;
            if (newW > 150 && newW < 400) sidebar.style.width = newW + 'px';
        }
        if (isResizingD) {
            // dailySplit (parent) offsetini hesaba kat
            const containerOffset = document.getElementById('dailySplit').getBoundingClientRect().left;
            let newW = e.clientX - containerOffset;
            if (newW > 200 && newW < 600) dLeft.style.width = newW + 'px';
        }
    });

    document.addEventListener('mouseup', () => {
        isResizingSb = false; isResizingD = false; document.body.style.cursor = 'default';
    });

    // --- INIT ---
    window.initApp = () => {
        const sel = document.getElementById('tTitle'); TOPICS.forEach(t=>sel.innerHTML+=`<option>${t}</option>`);
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString('tr-TR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginScreen').style.display='none';
                document.getElementById('uName').innerText = user.email.split('@')[0];
                listenData();
                if(window.innerWidth > 768) initSortable();
            }
        });
    }

    window.login = () => { const e=document.getElementById('email').value, p=document.getElementById('password').value; signInWithEmailAndPassword(auth,e,p).catch(err=>{ if(err.code.includes('not-found')) createUserWithEmailAndPassword(auth,e,p); else document.getElementById('loginError').innerText=err.message; }); }
    window.logout = () => signOut(auth).then(()=>location.reload());

    function listenData() {
        if(!db) return;
        onSnapshot(query(collection(db,"tasks"),orderBy("code","desc")), (snap)=>{
            tasks = snap.docs.map(d=>({id:d.id, ...d.data()}));
            renderAll();
        });
    }

    function renderAll() {
        renderStats(); renderCalendar(); renderDayList(); renderKanban(); renderList();
    }

    // --- DASHBOARD ---
    function renderStats() {
        const c = {todo:0, progress:0, done:0}; tasks.forEach(t=>{if(c[t.status]!==undefined)c[t.status]++});
        document.getElementById('dTotal').innerText = tasks.length;
        document.getElementById('dTodo').innerText = c.todo;
        document.getElementById('dProg').innerText = c.progress;
        document.getElementById('dDone').innerText = c.done;
        
        if(window.chart) window.chart.destroy();
        window.chart = new Chart(document.getElementById('chartStatus'), {
            type:'bar',
            data:{ labels:['Bekleyen','İşlemde','Biten'], datasets:[{label:'Adet',data:[c.todo,c.progress,c.done], backgroundColor:['#f59e0b','#3b82f6','#10b981'], borderRadius:6}] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
    }

    // --- DAILY CALENDAR ---
    function renderCalendar() {
        const y=calDate.getFullYear(), m=calDate.getMonth();
        document.getElementById('calTitle').innerText = calDate.toLocaleDateString('tr-TR',{month:'long',year:'numeric'});
        const g = document.getElementById('calendarGrid'); g.innerHTML='';
        const fDay=new Date(y,m,1).getDay(), off=fDay===0?6:fDay-1, days=new Date(y,m+1,0).getDate();
        
        for(let i=0; i<off; i++) g.innerHTML+='<div></div>';
        for(let i=1; i<=days; i++) {
            const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dayTasks = tasks.filter(t=>t.date===ds && t.status!=='done');
            let dots = ''; dayTasks.forEach(t=> { let c = t.priority==='Yüksek'?'#ef4444':(t.priority==='Orta'?'#f59e0b':'#10b981'); dots+=`<div class="dot" style="background:${c}"></div>`; });
            
            const isToday = new Date().toDateString() === new Date(y,m,i).toDateString();
            const isSel = activeDate.toDateString() === new Date(y,m,i).toDateString();
            
            const d = document.createElement('div');
            d.className = `c-day ${isToday?'today':''} ${isSel?'selected':''}`;
            d.innerHTML = `<div>${i}</div><div class="dot-indicators">${dots}</div>`;
            d.onclick = () => { activeDate = new Date(y,m,i); renderDayList(); renderCalendar(); };
            g.appendChild(d);
        }
    }
    
    function renderDayList() {
        const ds = `${activeDate.getFullYear()}-${String(activeDate.getMonth()+1).padStart(2,'0')}-${String(activeDate.getDate()).padStart(2,'0')}`;
        document.getElementById('selDateDisp').innerText = activeDate.toLocaleDateString('tr-TR',{day:'numeric',month:'long'});
        const l = document.getElementById('dayTaskList'); l.innerHTML = '';
        const dt = tasks.filter(t=>t.date===ds);
        if(dt.length===0) l.innerHTML='<div style="text-align:center; padding:30px; color:var(--text-muted);">Boş</div>';
        
        dt.forEach(t => {
            const stC = t.status==='done'?'#10b981':(t.status==='progress'?'#3b82f6':'#f59e0b');
            l.innerHTML += `
            <div class="d-task-item" onclick="openModal('${t.id}')">
                <div class="d-status-line" style="background:${stC}"></div>
                <div class="d-time">${t.time||'--:--'}</div>
                <div class="d-info"><h4>${t.title}</h4><p>${t.desc||''}</p></div>
            </div>`;
        });
    }
    window.navCal = (d) => { calDate.setMonth(calDate.getMonth()+d); renderCalendar(); }
    window.newTaskForDate = () => { document.getElementById('tId').value=''; document.getElementById('tTitle').value=''; const ds=`${activeDate.getFullYear()}-${String(activeDate.getMonth()+1).padStart(2,'0')}-${String(activeDate.getDate()).padStart(2,'0')}`; document.getElementById('tDate').value=ds; document.getElementById('modal').classList.add('open'); }

    // --- KANBAN ---
    function renderKanban() {
        const cols={todo:document.getElementById('col-todo'), progress:document.getElementById('col-progress'), done:document.getElementById('col-done')};
        Object.values(cols).forEach(e=>e.innerHTML='');
        const cnt={todo:0, progress:0, done:0};
        tasks.forEach(t=>{
            if(cols[t.status]) {
                cnt[t.status]++;
                cols[t.status].innerHTML += `
                <div class="k-card" onclick="openModal('${t.id}')">
                    <span class="k-tag">${t.code}</span>
                    <div style="font-weight:600; margin-bottom:5px;">${t.title}</div>
                    <div style="font-size:11px; color:var(--text-muted);">${t.date||''}</div>
                </div>`;
            }
        });
        document.getElementById('k-todo-c').innerText=cnt.todo; document.getElementById('k-prog-c').innerText=cnt.progress; document.getElementById('k-done-c').innerText=cnt.done;
    }

    // --- LIST ---
    window.renderList = () => {
        const s = document.getElementById('searchInp').value.toLowerCase();
        const f = document.getElementById('filterStat').value;
        const b = document.getElementById('fullListBody'); b.innerHTML='';
        tasks.filter(t => (f==='all'||t.status===f) && t.title.toLowerCase().includes(s)).forEach(t => {
            b.innerHTML += `<tr class="list-row" onclick="openModal('${t.id}')"><td>${t.code}</td><td>${t.title}</td><td>${t.date||''}</td><td>${t.status}</td></tr>`;
        });
    }

    // --- ACTIONS ---
    window.showView = (v, btn) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.getElementById('pageTitle').innerText = (v==='dashboard'?'Özet Rapor':(v==='kanban'?'İş Panosu':(v==='daily'?'Günlük Plan':'Tüm Liste')));
        if(btn) { document.querySelectorAll('.nav-item, .m-nav-item').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        if(v==='list') renderList();
    }

    window.newTask = () => { document.getElementById('tId').value=''; document.getElementById('tTitle').value=''; document.getElementById('modal').classList.add('open'); }
    window.closeModal = () => document.getElementById('modal').classList.remove('open');
    window.openModal = (id) => {
        const t = tasks.find(x=>x.id===id);
        if(t) {
            document.getElementById('tId').value=t.id; document.getElementById('tTitle').value=t.title;
            document.getElementById('tStatus').value=t.status; document.getElementById('tPriority').value=t.priority;
            document.getElementById('tDate').value=t.date; document.getElementById('tTime').value=t.time||'';
            document.getElementById('tDesc').value=t.desc; document.getElementById('modal').classList.add('open');
        }
    }
    
    window.saveTask = async () => {
        const id = document.getElementById('tId').value;
        const d = { title:document.getElementById('tTitle').value, status:document.getElementById('tStatus').value, priority:document.getElementById('tPriority').value, date:document.getElementById('tDate').value, time:document.getElementById('tTime').value, desc:document.getElementById('tDesc').value };
        if(id) await updateDoc(doc(db,"tasks",id),d);
        else { await runTransaction(db, async(t)=>{ const r=doc(db,"meta","counters"); const s=await t.get(r); const n=(s.exists()?s.data().taskSeq:0)+1; t.set(r,{taskSeq:n},{merge:true}); d.code='GRV-'+n; await addDoc(collection(db,"tasks"),d); }); }
        closeModal();
    }
    
    window.delTask = async () => { if(confirm('Sil?')) { await deleteDoc(doc(db,"tasks",document.getElementById('tId').value)); closeModal(); } }
    window.exportExcel = () => { const ws=XLSX.utils.json_to_sheet(tasks); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Tasks"); XLSX.writeFile(wb,"BT_Data.xlsx"); }
    window.toggleTheme = () => { const b=document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')==='dark'?'light':'dark'); }

    function initSortable() {
        ['col-todo','col-progress','col-done'].forEach(id => new Sortable(document.getElementById(id), { group:'k', onEnd: async(e)=>{ await updateDoc(doc(db,"tasks",e.item.getAttribute('onclick').split("'")[1]), {status:e.to.getAttribute('data-status')}); } }));
    }
</script>
</body>
</html>
