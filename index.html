<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Halk Faktoring | Cyber Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-hover: rgba(255, 255, 255, 0.05);
            --border: 1px solid rgba(255, 255, 255, 0.1);
            
            --primary: #38bdf8; 
            --secondary: #818cf8;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            
            --radius: 16px;
            --header-h: 70px;
            --sidebar-w: 260px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark); color: var(--text-main);
            height: 100vh; width: 100vw; overflow: hidden; display: flex;
            /* Canlı Arka Plan */
            background-image: radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.15) 0%, transparent 40%),
                              radial-gradient(circle at 90% 80%, rgba(129, 140, 248, 0.15) 0%, transparent 40%);
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: var(--sidebar-w); height: 100%; border-right: var(--border);
            display: flex; flex-direction: column; background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px); z-index: 50; flex-shrink: 0;
        }

        .main-content {
            flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative;
        }

        /* --- SIDEBAR COMPONENTS --- */
        .logo-box {
            height: var(--header-h); display: flex; align-items: center; padding: 0 24px;
            font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px;
            border-bottom: var(--border);
        }
        .logo-box i { margin-right: 10px; }

        .nav-menu { flex: 1; padding: 20px; overflow-y: auto; }
        .nav-item {
            display: flex; align-items: center; padding: 14px 16px; color: var(--text-muted);
            border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; font-weight: 600; font-size: 14px;
        }
        .nav-item i { width: 24px; margin-right: 10px; font-size: 18px; }
        .nav-item:hover { background: var(--bg-hover); color: #fff; }
        .nav-item.active { background: linear-gradient(90deg, rgba(56,189,248,0.15), transparent); color: var(--primary); border-left: 3px solid var(--primary); }

        .user-box {
            padding: 20px; border-top: var(--border); display: flex; align-items: center; gap: 12px;
        }
        .avatar {
            width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700;
        }

        /* --- HEADER --- */
        .topbar {
            height: var(--header-h); border-bottom: var(--border); display: flex; align-items: center;
            justify-content: space-between; padding: 0 30px; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px);
        }
        .page-title h2 { margin: 0; font-size: 20px; }
        .page-title p { margin: 0; font-size: 12px; color: var(--text-muted); }

        .btn-primary {
            background: var(--primary); color: #000; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: 0.2s; box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        }
        .btn-primary:hover { transform: scale(1.05); background: #7dd3fc; }

        /* --- VIEWS --- */
        .view-section { flex: 1; padding: 24px; overflow-y: auto; display: none; flex-direction: column; gap: 24px; }
        .view-section.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- 1. DASHBOARD (BENTO GRID FIX) --- */
        .bento-grid {
            display: grid; 
            grid-template-columns: repeat(4, 1fr); /* 4 Sütun */
            grid-auto-rows: minmax(140px, auto); /* Otomatik Satır */
            gap: 20px;
        }
        
        .card {
            background: var(--bg-card); border: var(--border); border-radius: var(--radius);
            padding: 20px; display: flex; flex-direction: column; position: relative; overflow: hidden;
            backdrop-filter: blur(10px); transition: transform 0.2s;
        }
        .card:hover { border-color: rgba(255,255,255,0.2); }

        /* Kart Yerleşimleri */
        .span-1 { grid-column: span 1; }
        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }
        .row-2 { grid-row: span 2; }

        /* Stat Kartları */
        .stat-icon { font-size: 24px; margin-bottom: 10px; opacity: 0.8; }
        .stat-val { font-size: 32px; font-weight: 800; color: #fff; }
        .stat-lbl { font-size: 12px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }

        /* Takvim */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; height: 100%; }
        .cal-head { text-align: center; font-size: 11px; color: var(--text-muted); padding-bottom: 10px; border-bottom: var(--border); margin-bottom: 10px; }
        .c-cell { 
            background: rgba(255,255,255,0.03); min-height: 80px; padding: 5px; cursor: pointer; 
            border-radius: 4px; transition: 0.2s; display: flex; flex-direction: column;
        }
        .c-cell:hover { background: rgba(255,255,255,0.08); }
        .c-cell.today { border: 1px solid var(--primary); background: rgba(56, 189, 248, 0.1); }
        .c-num { font-size: 12px; font-weight: 700; text-align: right; margin-bottom: 4px; }
        .c-dot { height: 6px; width: 6px; border-radius: 50%; background: var(--secondary); margin-bottom: 2px; }

        /* --- 2. TIMELINE --- */
        .timeline-box { background: var(--bg-card); border: var(--border); border-radius: var(--radius); flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tl-row { display: flex; align-items: center; border-bottom: var(--border); height: 50px; }
        .tl-name { width: 200px; padding: 0 15px; border-right: var(--border); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }
        .tl-track { flex: 1; position: relative; height: 100%; display: flex; align-items: center; }
        .tl-bar { 
            height: 24px; border-radius: 12px; background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            position: absolute; display: flex; align-items: center; padding: 0 10px; font-size: 11px; font-weight: 700; color: #000;
            box-shadow: 0 0 10px var(--primary); white-space: nowrap; overflow: hidden;
        }

        /* --- 3. KANBAN --- */
        .kanban-wrap { display: flex; gap: 20px; height: 100%; overflow-x: auto; padding-bottom: 10px; }
        .kb-col { 
            flex: 1; min-width: 300px; background: rgba(0,0,0,0.2); 
            border: var(--border); border-radius: 12px; display: flex; flex-direction: column; 
        }
        .kb-head { padding: 15px; font-weight: 700; border-bottom: var(--border); display: flex; justify-content: space-between; }
        .kb-body { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .kb-card { 
            background: rgba(30, 41, 59, 0.8); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); 
            cursor: grab; border-left: 3px solid transparent; 
        }
        .kb-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.2); }
        
        /* Öncelik Renkleri */
        .p-High { border-left-color: var(--danger); }
        .p-Mid { border-left-color: var(--warning); }
        .p-Low { border-left-color: var(--success); }

        /* --- 4. LISTE --- */
        .list-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .list-table th { text-align: left; padding: 15px; border-bottom: var(--border); color: var(--text-muted); }
        .list-table td { padding: 15px; border-bottom: var(--border); }
        .list-table tr:hover td { background: rgba(255,255,255,0.05); }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: #1e293b; width: 500px; padding: 30px; border-radius: 20px; border: var(--border); box-shadow: 0 0 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        
        .inp-group { margin-bottom: 15px; }
        .inp-lbl { display: block; margin-bottom: 5px; font-size: 12px; color: var(--text-muted); font-weight: 700; }
        .inp-ctrl { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: var(--border); border-radius: 8px; color: #fff; font-family: inherit; }
        .inp-ctrl:focus { border-color: var(--primary); }

        /* MOBILE NAV */
        .bottom-nav { display: none; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .bento-grid, .dash-grid { display: flex; flex-direction: column; }
            .card { min-height: 120px; }
            .box-cal { min-height: 400px; }
            .main-content { padding-bottom: 80px; }
            
            .bottom-nav { 
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; 
                background: rgba(15, 23, 42, 0.95); border-top: var(--border); z-index: 2000; 
                justify-content: space-around; align-items: center; padding-bottom: 10px;
            }
            .bn-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 10px; gap: 4px; background: none; border: none; }
            .bn-item.active { color: var(--primary); }
            .bn-item i { font-size: 20px; }
            .modal-content { width: 100%; height: 100%; border-radius: 0; }
        }
    </style>
</head>
<body onload="initApp()">

    <div id="loginScreen" style="position:fixed; inset:0; background:var(--bg-dark); z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div style="background:rgba(30,41,59,0.8); padding:40px; border-radius:20px; border:var(--border); width:320px; text-align:center;">
            <i class="fa-solid fa-cube" style="font-size:40px; color:var(--primary); margin-bottom:20px;"></i>
            <h2 style="margin:0 0 20px; color:#fff;">BT Portal</h2>
            <input type="email" id="email" class="inp-ctrl" placeholder="E-posta" style="margin-bottom:10px;">
            <input type="password" id="password" class="inp-ctrl" placeholder="Şifre" style="margin-bottom:20px;">
            <button class="btn-primary" style="width:100%; justify-content:center;" onclick="login()">Giriş Yap</button>
        </div>
    </div>

    <aside class="sidebar">
        <div class="logo-box"><i class="fa-solid fa-cube"></i> HALK BT</div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="setView('dashboard', this)"><i class="fa-solid fa-grid-2"></i> Özet</div>
            <div class="nav-item" onclick="setView('timeline', this)"><i class="fa-solid fa-timeline"></i> Zaman</div>
            <div class="nav-item" onclick="setView('kanban', this)"><i class="fa-solid fa-columns"></i> Pano</div>
            <div class="nav-item" onclick="setView('list', this)"><i class="fa-solid fa-list"></i> Liste</div>
        </div>
        <div class="user-box">
            <div class="avatar">CK</div>
            <div style="flex:1; margin-left:10px; font-weight:600;">Kullanıcı</div>
            <i class="fa-solid fa-power-off" style="cursor:pointer; color:var(--danger);" onclick="logout()"></i>
        </div>
    </aside>

    <main class="main-content">
        <div class="topbar">
            <div class="page-title">
                <h2 id="pageTitle">Genel Bakış</h2>
                <p id="dateStr">...</p>
            </div>
            <button class="btn-primary" onclick="openModal()">+ Yeni İş</button>
        </div>

        <div id="v-dashboard" class="view-section active">
            <div class="bento-grid">
                <div class="card span-1"><div class="stat-icon" style="color:var(--warning)"><i class="fa-solid fa-clock"></i></div><div class="stat-lbl">Bekleyen</div><div class="stat-val" id="dTodo">0</div></div>
                <div class="card span-1"><div class="stat-icon" style="color:var(--primary)"><i class="fa-solid fa-spinner"></i></div><div class="stat-lbl">İşlemde</div><div class="stat-val" id="dProg">0</div></div>
                <div class="card span-1"><div class="stat-icon" style="color:var(--success)"><i class="fa-solid fa-check"></i></div><div class="stat-lbl">Tamamlanan</div><div class="stat-val" id="dDone">0</div></div>
                <div class="card span-1"><div class="stat-icon" style="color:#fff"><i class="fa-solid fa-users"></i></div><div class="stat-lbl">Ekip</div><div class="stat-val">3</div></div>
                
                <div class="card span-3 row-2 box-cal">
                    <div class="cal-header">
                        <span id="calTitle" style="font-size:18px; font-weight:700; color:var(--primary);">...</span>
                        <div>
                            <button onclick="navCal(-1)" style="background:none; border:none; color:#fff; font-size:16px; cursor:pointer;"><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="navCal(1)" style="background:none; border:none; color:#fff; font-size:16px; cursor:pointer;"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="cal-grid" style="grid-template-rows: auto 1fr;">
                        <div class="cal-head" style="display:grid; grid-template-columns:repeat(7,1fr);">
                            <div>PZT</div><div>SAL</div><div>ÇAR</div><div>PER</div><div>CUM</div><div style="color:var(--danger)">CMT</div><div style="color:var(--danger)">PAZ</div>
                        </div>
                        <div id="calBody" style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px; overflow-y:auto;"></div>
                    </div>
                </div>

                <div class="card span-1 row-2">
                    <h3 style="margin:0 0 20px;">Performans</h3>
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>

        <div id="v-timeline" class="view-section">
            <div class="timeline-box">
                <div class="tl-row" style="background:rgba(255,255,255,0.05); font-weight:700; color:var(--text-muted);">
                    <div class="tl-name" style="border:none;">GÖREV ADI</div>
                    <div style="padding-left:10px;">ZAMAN ÇİZELGESİ (Bu Ay)</div>
                </div>
                <div id="timelineContent" style="flex:1; overflow-y:auto;"></div>
            </div>
        </div>

        <div id="v-kanban" class="view-section">
            <div class="kanban-wrap">
                <div class="kb-col">
                    <div class="kb-head">BEKLEYEN <span id="k-todo-c" style="background:var(--warning); color:#000; padding:2px 6px; border-radius:4px; font-size:10px;">0</span></div>
                    <div class="kb-body" id="col-todo" data-status="todo"></div>
                </div>
                <div class="kb-col">
                    <div class="kb-head">İŞLEMDE <span id="k-prog-c" style="background:var(--primary); color:#000; padding:2px 6px; border-radius:4px; font-size:10px;">0</span></div>
                    <div class="kb-body" id="col-progress" data-status="progress"></div>
                </div>
                <div class="kb-col">
                    <div class="kb-head">BİTEN <span id="k-done-c" style="background:var(--success); color:#000; padding:2px 6px; border-radius:4px; font-size:10px;">0</span></div>
                    <div class="kb-body" id="col-done" data-status="done"></div>
                </div>
            </div>
        </div>

        <div id="v-list" class="view-section">
            <div class="card" style="padding:0;">
                <table class="list-table">
                    <thead><tr><th>Durum</th><th>Konu</th><th>Tarih</th><th>Açıklama</th></tr></thead>
                    <tbody id="listBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="bottom-nav">
        <button class="bn-item active" onclick="setView('dashboard', this)"><i class="fa-solid fa-grid-2"></i></button>
        <button class="bn-item" onclick="setView('timeline', this)"><i class="fa-solid fa-timeline"></i></button>
        <button class="bn-item" onclick="openModal()" style="color:var(--primary)"><i class="fa-solid fa-plus-circle" style="font-size:30px;"></i></button>
        <button class="bn-item" onclick="setView('kanban', this)"><i class="fa-solid fa-columns"></i></button>
        <button class="bn-item" onclick="setView('list', this)"><i class="fa-solid fa-list"></i></button>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;">Görev Detayı</h3>
                <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:20px;" onclick="closeModal()"></i>
            </div>
            <input type="hidden" id="tId">
            <div class="inp-group"><label class="inp-lbl">Konu</label><select id="tTitle" class="inp-ctrl"></select></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="inp-group"><label class="inp-lbl">Durum</label><select id="tStatus" class="inp-ctrl"><option value="todo">Bekliyor</option><option value="progress">İşlemde</option><option value="done">Tamamlandı</option></select></div>
                <div class="inp-group"><label class="inp-lbl">Öncelik</label><select id="tPriority" class="inp-ctrl"><option value="Düşük">Düşük</option><option value="Orta">Orta</option><option value="Yüksek">Yüksek</option></select></div>
            </div>
            <div class="inp-group"><label class="inp-lbl">Tarih</label><input type="date" id="tDate" class="inp-ctrl"></div>
            <div class="inp-group"><label class="inp-lbl">Açıklama</label><textarea id="tDesc" class="inp-ctrl" rows="3"></textarea></div>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button class="btn-primary" style="background:var(--danger);" onclick="delTask()">Sil</button>
                <button class="btn-primary" onclick="saveTask()">Kaydet</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, runTransaction, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIG ---
    const firebaseConfig = { apiKey: "AIzaSyAvPpg1Qa6XF8kPV_VZXq7BE04geXLqo4s", authDomain: "it-tasks-bc974.firebaseapp.com", projectId: "it-tasks-bc974", storageBucket: "it-tasks-bc974.firebasestorage.app", messagingSenderId: "978679373454", appId: "1:978679373454:web:3ee1c689cf1ca321af33df" };
    let app, db, auth; 
    try { app=initializeApp(firebaseConfig); db=getFirestore(app); auth=getAuth(app); } catch(e){console.log(e);}

    const TOPICS = ["Infact", "Rating", "Dijital Mizan", "KDS", "Mobil Uygulama", "Satın Alım", "RM/KKB", "Halkbank", "Denetim", "Diğer"];
    let tasks = []; let calDate = new Date();

    // --- CORE FUNCTIONS ---
    window.initApp = () => {
        // Doldur Select
        const s = document.getElementById('tTitle'); 
        if(s) TOPICS.forEach(t => s.innerHTML += `<option>${t}</option>`);
        
        // Tarih Yaz
        document.getElementById('dateStr').innerText = new Date().toLocaleDateString('tr-TR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});

        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('loginScreen').style.display = 'none';
                listenData();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        });
    }

    window.login = () => { 
        const e = document.getElementById('email').value; 
        const p = document.getElementById('password').value;
        signInWithEmailAndPassword(auth,e,p).catch(err => alert(err.message));
    }
    window.logout = () => signOut(auth).then(() => location.reload());

    function listenData() {
        if(!db) return;
        onSnapshot(query(collection(db, "tasks"), orderBy("code", "desc")), (snap) => {
            tasks = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderAll();
        });
    }

    function renderAll() {
        renderStats();
        renderCalendar();
        renderTimeline();
        renderKanban();
        renderList();
    }

    // --- 1. DASHBOARD ---
    function renderStats() {
        const c = {todo:0, progress:0, done:0};
        tasks.forEach(t => { if(c[t.status] !== undefined) c[t.status]++; });
        
        document.getElementById('dTodo').innerText = c.todo;
        document.getElementById('dProg').innerText = c.progress;
        document.getElementById('dDone').innerText = c.done;

        // Chart
        if(window.myChartInstance) window.myChartInstance.destroy();
        const ctx = document.getElementById('myChart');
        if(ctx) {
            window.myChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Bekleyen', 'İşlemde', 'Biten'],
                    datasets: [{
                        data: [c.todo, c.progress, c.done],
                        backgroundColor: ['#fbbf24', '#38bdf8', '#34d399'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
                }
            });
        }
    }

    function renderCalendar() {
        const y = calDate.getFullYear(), m = calDate.getMonth();
        const title = document.getElementById('calTitle');
        if(title) title.innerText = calDate.toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
        
        const g = document.getElementById('calBody');
        if(!g) return;
        g.innerHTML = '';

        const fDay = new Date(y, m, 1).getDay();
        const offset = fDay === 0 ? 6 : fDay - 1; // Pzt=0
        const days = new Date(y, m + 1, 0).getDate();

        for(let i=0; i<offset; i++) g.innerHTML += '<div></div>';

        const nowStr = new Date().toDateString();

        for(let i=1; i<=days; i++) {
            const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dayTasks = tasks.filter(t => t.date === ds && t.status !== 'done');
            
            // Dots logic
            let dots = '';
            dayTasks.forEach(t => dots += `<div class="c-dot" style="background:${t.priority==='Yüksek'?'#f87171':'#38bdf8'}"></div>`);
            
            const isToday = new Date(y,m,i).toDateString() === nowStr;
            
            g.innerHTML += `
            <div class="c-cell ${isToday ? 'today' : ''}" onclick="alert('${ds} Tarihli İşler')">
                <div class="c-num">${i}</div>
                <div style="display:flex; gap:2px; flex-wrap:wrap;">${dots}</div>
            </div>`;
        }
    }
    window.navCal = (n) => { calDate.setMonth(calDate.getMonth() + n); renderCalendar(); }

    // --- 2. TIMELINE ---
    function renderTimeline() {
        const el = document.getElementById('timelineContent');
        if(!el) return;
        el.innerHTML = '';
        
        tasks.slice(0, 20).forEach(t => {
            if(!t.date) return;
            // Fake duration simulation logic
            const dateVal = new Date(t.date).getDate(); // 1-31
            const width = Math.max(10, (dateVal / 30) * 100); 
            
            el.innerHTML += `
            <div class="tl-row">
                <div class="tl-name">${t.title}</div>
                <div class="tl-track">
                    <div class="tl-bar" style="width:${width}%; left:0;">${t.date}</div>
                </div>
            </div>`;
        });
    }

    // --- 3. KANBAN ---
    function renderKanban() {
        const cols = {todo:document.getElementById('col-todo'), progress:document.getElementById('col-progress'), done:document.getElementById('col-done')};
        if(!cols.todo) return;
        Object.values(cols).forEach(e => e.innerHTML='');
        
        const counts = {todo:0, progress:0, done:0};

        tasks.forEach(t => {
            if(cols[t.status]) {
                counts[t.status]++;
                let pClass = t.priority === 'Yüksek' ? 'p-High' : (t.priority === 'Orta' ? 'p-Mid' : 'p-Low');
                
                cols[t.status].innerHTML += `
                <div class="kb-card ${pClass}" onclick="openModal('${t.id}')">
                    <div style="font-weight:700; font-size:14px; margin-bottom:5px;">${t.title}</div>
                    <div style="font-size:12px; color:#94a3b8;">${t.desc || ''}</div>
                </div>`;
            }
        });
        
        document.getElementById('k-todo-c').innerText = counts.todo;
        document.getElementById('k-prog-c').innerText = counts.progress;
        document.getElementById('k-done-c').innerText = counts.done;

        // Init Sortable
        ['col-todo', 'col-progress', 'col-done'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                new Sortable(el, { 
                    group: 'k', 
                    animation: 150,
                    onEnd: async (evt) => {
                        const itemEl = evt.item;
                        const newStatus = evt.to.getAttribute('data-status');
                        const oldOnclick = itemEl.getAttribute('onclick'); 
                        const idMatch = oldOnclick.match(/'([^']+)'/);
                        if(idMatch) {
                            await updateDoc(doc(db, "tasks", idMatch[1]), { status: newStatus });
                            if(newStatus === 'done') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        }
                    }
                });
            }
        });
    }

    // --- 4. LIST ---
    function renderList() {
        const tb = document.getElementById('listBody');
        if(!tb) return;
        tb.innerHTML = '';
        tasks.forEach(t => {
            tb.innerHTML += `<tr onclick="openModal('${t.id}')"><td>${t.status}</td><td>${t.title}</td><td>${t.date||''}</td><td>${t.desc||''}</td></tr>`;
        });
    }

    // --- COMMON ---
    window.setView = (v, btn) => {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.getElementById('v-'+v).classList.add('active');
        document.querySelectorAll('.nav-item, .bn-item').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        if(v==='dashboard') { renderStats(); renderCalendar(); }
        if(v==='kanban') renderKanban();
        if(v==='timeline') renderTimeline();
        if(v==='list') renderList();
    }

    window.openModal = (id) => {
        const modal = document.getElementById('modal');
        modal.classList.add('open');
        document.getElementById('tId').value = '';
        document.getElementById('tTitle').value = '';
        document.getElementById('tDesc').value = '';
        
        if(id) {
            const t = tasks.find(x => x.id === id);
            if(t) {
                document.getElementById('tId').value = t.id;
                document.getElementById('tTitle').value = t.title;
                document.getElementById('tStatus').value = t.status;
                document.getElementById('tPriority').value = t.priority;
                document.getElementById('tDate').value = t.date;
                document.getElementById('tDesc').value = t.desc;
            }
        }
    }
    window.closeModal = () => document.getElementById('modal').classList.remove('open');

    window.saveTask = async () => {
        const id = document.getElementById('tId').value;
        const d = {
            title: document.getElementById('tTitle').value,
            status: document.getElementById('tStatus').value,
            priority: document.getElementById('tPriority').value,
            date: document.getElementById('tDate').value,
            desc: document.getElementById('tDesc').value
        };

        if(id) {
            await updateDoc(doc(db, "tasks", id), d);
        } else {
            await runTransaction(db, async(t)=>{ 
                const r=doc(db,"meta","counters"); const s=await t.get(r); 
                const n=(s.exists()?s.data().taskSeq:0)+1; 
                t.set(r,{taskSeq:n},{merge:true}); 
                d.code='GRV-'+n; 
                await addDoc(collection(db,"tasks"),d); 
            }); 
        }
        closeModal();
    }

    window.delTask = async () => {
        const id = document.getElementById('tId').value;
        if(id && confirm('Silmek istediğine emin misin?')) {
            await deleteDoc(doc(db, "tasks", id));
            closeModal();
        }
    }

</script>
</body>
</html>
