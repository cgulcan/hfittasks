<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Halk Faktoring | BT Yönetim</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            /* KURUMSAL RENK PALETİ (CLEAN & SHARP) */
            --bg-body: #F3F4F6;       /* Açık Gri Zemin */
            --sidebar-bg: #0F172A;    /* Koyu Lacivert Sidebar */
            --sidebar-text: #94A3B8;
            --sidebar-active: #3B82F6;
            
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            
            --text-primary: #111827;
            --text-secondary: #6B7280;
            
            --primary: #2563EB;       /* Ana Aksiyon Rengi */
            --primary-hover: #1D4ED8;
            
            /* Durum Renkleri */
            --tag-critical-bg: #FEF2F2; --tag-critical-text: #DC2626;
            --tag-high-bg: #FFF7ED;     --tag-high-text: #EA580C;
            --tag-norm-bg: #EFF6FF;     --tag-norm-text: #2563EB;
            --tag-done-bg: #F0FDF4;     --tag-done-text: #16A34A;

            --radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            --header-h: 64px;
            --sidebar-w: 260px;
            --bottom-nav-h: 70px;
        }

        [data-theme="dark"] {
            --bg-body: #0B1120;
            --sidebar-bg: #020617;
            --card-bg: #1E293B;
            --border-color: #334155;
            --text-primary: #F9FAFB;
            --text-secondary: #94A3B8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; transition: background 0.3s; }

        /* --- SIDEBAR (DESKTOP) --- */
        .sidebar {
            width: var(--sidebar-w); background: var(--sidebar-bg);
            display: flex; flex-direction: column; flex-shrink: 0;
            transition: 0.3s; z-index: 50;
        }
        .logo-area {
            height: var(--header-h); display: flex; align-items: center; padding: 0 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #fff; font-weight: 700; font-size: 18px; letter-spacing: -0.5px; gap: 10px;
        }
        .nav-menu { flex: 1; padding: 20px 12px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            color: var(--sidebar-text); font-size: 14px; font-weight: 500;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .nav-item i { width: 20px; text-align: center; font-size: 16px; }

        .user-profile {
            padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 12px; color: #fff;
        }
        .avatar { width: 36px; height: 36px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; }
        .u-det h4 { margin: 0; font-size: 14px; } .u-det p { margin: 0; font-size: 11px; color: var(--sidebar-text); }

        /* --- MAIN CONTENT --- */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .topbar {
            height: var(--header-h); background: var(--card-bg); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
            flex-shrink: 0;
        }
        .page-header h1 { margin: 0; font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .page-header p { margin: 0; font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        
        .top-actions { display: flex; gap: 12px; }
        .icon-btn {
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--card-bg); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .icon-btn:hover { background: var(--bg-body); color: var(--text-primary); }
        
        .btn-primary {
            background: var(--primary); color: #fff; border: none; padding: 0 20px; height: 40px;
            border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

        /* --- VIEW AREA --- */
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
        .view-section { display: none; animation: fadein 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD GRID --- */
        .grid-dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px; }
        .card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow-sm); }
        
        .stat-card { display: flex; flex-direction: column; gap: 8px; }
        .stat-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 8px; }
        .stat-val { font-size: 28px; font-weight: 700; color: var(--text-primary); line-height: 1; }
        .stat-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }

        /* --- GÜNLÜK (DAILY) LAYOUT --- */
        .daily-wrapper { display: grid; grid-template-columns: 350px 1fr; gap: 24px; height: calc(100vh - 160px); }
        .daily-col { display: flex; flex-direction: column; gap: 20px; height: 100%; overflow: hidden; }
        
        /* Modern Takvim */
        .calendar-widget { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 20px; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-title { font-weight: 700; font-size: 16px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-head { text-align: center; font-size: 11px; font-weight: 600; color: var(--text-secondary); padding: 8px 0; }
        .cal-cell { 
            height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: 0.2s; position: relative;
            color: var(--text-primary);
        }
        .cal-cell:hover { background: var(--bg-body); }
        .cal-cell.today { background: var(--primary); color: #fff; font-weight: 700; box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
        .cal-cell.has-task::after { content:''; width: 4px; height: 4px; background: #EA580C; border-radius: 50%; position: absolute; bottom: 4px; }
        .cal-cell.today.has-task::after { background: #fff; }

        /* Günlük Liste */
        .task-list-wrapper { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-right: 5px; }
        .daily-task-item {
            display: flex; gap: 16px; padding: 16px; 
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius);
            cursor: pointer; transition: 0.2s; align-items: center;
        }
        .daily-task-item:hover { transform: translateX(4px); border-color: var(--primary); }
        .dti-time { font-size: 14px; font-weight: 700; color: var(--text-secondary); min-width: 50px; }
        .dti-content { flex: 1; }
        .dti-title { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .dti-sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .dti-status { font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; }

        /* --- KANBAN --- */
        .kanban-container { display: flex; gap: 24px; height: 100%; overflow-x: auto; padding-bottom: 10px; }
        .kanban-col { 
            min-width: 320px; width: 320px; display: flex; flex-direction: column; 
            background: #F8FAFC; border-radius: 16px; border: 1px solid var(--border-color); height: 100%;
        }
        [data-theme="dark"] .kanban-col { background: #1E293B; }
        
        .kc-header { padding: 16px; font-weight: 700; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }
        .kc-body { padding: 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        
        .kanban-card { 
            background: var(--card-bg); padding: 16px; border-radius: 8px; 
            border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); 
            cursor: grab; transition: 0.2s; position: relative;
        }
        .kanban-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        .kanban-card::before { content:''; position: absolute; left: 0; top: 12px; bottom: 12px; width: 3px; border-radius: 0 4px 4px 0; background: #ccc; }
        .kc-p-Yüksek::before { background: #EF4444; } .kc-p-Orta::before { background: #F97316; } .kc-p-Düşük::before { background: #10B981; }
        
        .k-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; background: var(--bg-body); color: var(--text-secondary); border: 1px solid var(--border-color); display: inline-block; margin-bottom: 8px; }
        .k-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; line-height: 1.4; }
        .k-footer { display: flex; justify-content: space-between; margin-top: 12px; font-size: 11px; color: var(--text-secondary); align-items: center; }

        /* --- MODAL (BOTTOM SHEET ON MOBILE) --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal.show { display: flex; opacity: 1; }
        .modal-content { 
            background: var(--card-bg); width: 500px; padding: 30px; 
            border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal.show .modal-content { transform: scale(1); }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input { 
            width: 100%; padding: 12px; border: 1px solid var(--border-color); 
            border-radius: 8px; background: var(--bg-body); color: var(--text-primary); 
            font-size: 14px; font-family: inherit; transition: 0.2s; 
        }
        .form-input:focus { border-color: var(--primary); background: var(--card-bg); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* --- MOBILE BOTTOM NAV --- */
        .bottom-nav { display: none; }

        /* --- RESPONSIVE CSS --- */
        @media (max-width: 768px) {
            .sidebar { display: none; } /* Desktop menüyü gizle */
            .topbar { padding: 0 16px; }
            .content-scroll { padding: 16px; padding-bottom: 100px; } /* Alt menü payı */
            
            /* Mobil Alt Menü */
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
                height: var(--bottom-nav-height); background: var(--card-bg);
                border-top: 1px solid var(--border-color); z-index: 100;
                justify-content: space-around; align-items: center;
                padding-bottom: env(safe-area-inset-bottom);
                box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            }
            .bn-item {
                display: flex; flex-direction: column; align-items: center; gap: 4px;
                color: var(--text-secondary); font-size: 10px; font-weight: 600;
                background: none; border: none; width: 60px;
            }
            .bn-item i { font-size: 20px; }
            .bn-item.active { color: var(--primary); }
            
            /* Gridler Mobilde Tek Kolon */
            .grid-dashboard { grid-template-columns: 1fr 1fr; gap: 12px; }
            .daily-wrapper { grid-template-columns: 1fr; display: flex; flex-direction: column; gap: 20px; }
            
            /* Takvim Mobilde Üstte */
            .daily-col:first-child { height: auto; }
            .daily-col:last-child { flex: 1; }
            
            /* Kanban Yatay Kaydırma */
            .kanban-container { 
                padding-right: 16px; scroll-snap-type: x mandatory; 
                gap: 16px; 
            }
            .kanban-col { 
                min-width: 85vw; /* Ekrana otursun */
                scroll-snap-align: center;
            }
            
            /* Modal Bottom Sheet */
            .modal { align-items: flex-end; }
            .modal-content { 
                width: 100%; border-radius: 24px 24px 0 0; 
                padding: 24px; max-height: 90vh; overflow-y: auto;
                animation: slideUp 0.3s ease-out;
            }
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        }
    </style>
</head>
<body onload="initApp()">

<div id="loginOverlay" style="position:fixed; inset:0; background:var(--bg-body); z-index:2000; display:flex; align-items:center; justify-content:center;">
    <div style="background:var(--card-bg); padding:40px; border-radius:24px; border:1px solid var(--border-color); width:90%; max-width:360px; text-align:center; box-shadow:var(--shadow-md);">
        <img src="logo.png" style="width:64px; margin-bottom:24px;">
        <h2 style="margin:0 0 8px 0; color:var(--text-primary); font-size:22px;">BT Portal</h2>
        <p style="color:var(--text-secondary); font-size:14px; margin-bottom:32px;">Halk Faktoring A.Ş.</p>
        <div style="text-align:left; display:flex; flex-direction:column; gap:16px;">
            <input type="email" id="email" class="form-input" placeholder="E-posta Adresi">
            <input type="password" id="password" class="form-input" placeholder="Şifre">
        </div>
        <button class="btn-primary" style="width:100%; justify-content:center; margin-top:24px; height:48px;" onclick="login()">Giriş Yap</button>
        <div id="loginError" style="color:red; margin-top:16px; font-size:13px;"></div>
    </div>
</div>

<nav class="sidebar">
    <div class="logo-area">
        <img src="logo.png" style="width:24px; filter:brightness(0) invert(1);">
        <span>HALK BT</span>
    </div>
    <div class="nav-menu">
        <div class="nav-item active" onclick="showView('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> Özet</div>
        <div class="nav-item" onclick="showView('kanban', this)"><i class="fa-solid fa-columns"></i> Pano</div>
        <div class="nav-item" onclick="showView('daily', this)"><i class="fa-solid fa-calendar-day"></i> Günlük</div>
        <div class="nav-item" onclick="showView('list', this)"><i class="fa-solid fa-list"></i> Liste</div>
    </div>
    <div class="user-profile">
        <div class="avatar">CK</div>
        <div class="u-det">
            <h4 id="uName">Kullanıcı</h4>
            <p>BT Yönetici</p>
        </div>
        <i class="fa-solid fa-power-off" style="margin-left:auto; cursor:pointer;" onclick="logout()"></i>
    </div>
</nav>

<div class="main-wrapper">
    
    <div class="topbar">
        <div class="page-header">
            <h1 id="pageTitle">Genel Bakış</h1>
            <p id="todayDate">12 Aralık 2025</p>
        </div>
        <div class="top-actions">
            <div class="icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></div>
            <button class="btn-primary" onclick="newTask()">
                <i class="fa-solid fa-plus"></i> <span>Yeni Görev</span>
            </button>
        </div>
    </div>

    <div class="content-scroll">
        
        <div id="view-dashboard" class="view-section active">
            <div class="grid-dashboard">
                <div class="card stat-card">
                    <div class="stat-icon" style="background:#EFF6FF; color:#2563EB"><i class="fa-solid fa-folder-open"></i></div>
                    <div class="stat-val" id="dTotal">0</div>
                    <div class="stat-label">Toplam Görev</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon" style="background:#FFF7ED; color:#EA580C"><i class="fa-solid fa-clock"></i></div>
                    <div class="stat-val" id="dTodo">0</div>
                    <div class="stat-label">Bekleyen</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon" style="background:#F0FDF4; color:#16A34A"><i class="fa-solid fa-spinner"></i></div>
                    <div class="stat-val" id="dProg">0</div>
                    <div class="stat-label">İşlemde</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon" style="background:#F5F3FF; color:#7C3AED"><i class="fa-solid fa-check-circle"></i></div>
                    <div class="stat-val" id="dDone">0</div>
                    <div class="stat-label">Tamamlanan</div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:24px;">
                <div class="card" style="height:350px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <span style="font-weight:700;">Haftalık Performans</span>
                        <div class="icon-btn" onclick="exportExcel()" style="width:32px; height:32px;"><i class="fa-solid fa-download"></i></div>
                    </div>
                    <canvas id="chartStatus"></canvas>
                </div>
                <div class="card" id="dashCalendar">
                    </div>
            </div>
        </div>

        <div id="view-kanban" class="view-section" style="height:100%;">
            <div class="kanban-container">
                <div class="kanban-col">
                    <div class="kc-header">YAPILACAKLAR <span id="k-todo-cnt">0</span></div>
                    <div class="kc-body" id="col-todo" data-status="todo"></div>
                </div>
                <div class="kanban-col">
                    <div class="kc-header" style="color:#2563EB;">İŞLEMDE <span id="k-prog-cnt">0</span></div>
                    <div class="kc-body" id="col-progress" data-status="progress"></div>
                </div>
                <div class="kanban-col">
                    <div class="kc-header" style="color:#16A34A;">TAMAMLANDI <span id="k-done-cnt">0</span></div>
                    <div class="kc-body" id="col-done" data-status="done"></div>
                </div>
            </div>
        </div>

        <div id="view-daily" class="view-section" style="height:100%;">
            <div class="daily-wrapper">
                <div class="daily-col" style="flex:0 0 auto;">
                    <div class="calendar-widget">
                        <div class="cal-header">
                            <div class="icon-btn" onclick="navCal(-1)"><i class="fa-solid fa-chevron-left"></i></div>
                            <div class="cal-title" id="calTitle">Aralık 2025</div>
                            <div class="icon-btn" onclick="navCal(1)"><i class="fa-solid fa-chevron-right"></i></div>
                        </div>
                        <div class="cal-grid">
                            <div class="cal-head">Pt</div><div class="cal-head">Sa</div><div class="cal-head">Ça</div>
                            <div class="cal-head">Pe</div><div class="cal-head">Cu</div><div class="cal-head" style="color:#ef4444">Ct</div><div class="cal-head" style="color:#ef4444">Pa</div>
                        </div>
                        <div class="cal-grid" id="mainCalendar" style="margin-top:8px;"></div>
                    </div>
                    
                    <div class="card" style="padding:20px;">
                        <h4 style="margin:0 0 10px 0; font-size:14px;">Günün Özeti</h4>
                        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:5px;">
                            <span style="color:var(--text-secondary);">Planlanan İş:</span>
                            <span style="font-weight:700;" id="dayTotal">0</span>
                        </div>
                        <button class="btn-primary" style="width:100%; margin-top:15px; justify-content:center;" onclick="newTaskForDate()">+ Bu Güne Ekle</button>
                    </div>
                </div>

                <div class="daily-col">
                    <h3 style="margin:0; font-size:18px;">Seçili Tarih: <span id="selectedDateDisp" style="color:var(--primary);">Bugün</span></h3>
                    <div class="task-list-wrapper" id="dailyTaskList"></div>
                </div>
            </div>
        </div>

        <div id="view-list" class="view-section">
            <div class="card" style="padding:0; overflow:hidden;">
                <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; gap:12px;">
                    <input type="text" id="searchInput" placeholder="Görev ara..." class="form-input" style="width:250px;">
                    <select class="form-input" style="width:150px;" onchange="renderList(this.value)">
                        <option value="all">Tümü</option>
                        <option value="todo">Bekleyen</option>
                        <option value="done">Biten</option>
                    </select>
                </div>
                <div id="fullListContainer" style="max-height:600px; overflow-y:auto;"></div>
            </div>
        </div>

    </div>
</div>

<nav class="bottom-nav">
    <button class="bn-item active" onclick="showView('dashboard', this)"><i class="fa-solid fa-chart-pie"></i><span>Özet</span></button>
    <button class="bn-item" onclick="showView('kanban', this)"><i class="fa-solid fa-columns"></i><span>Pano</span></button>
    <button class="bn-item" style="color:var(--primary)" onclick="newTask()"><i class="fa-solid fa-circle-plus" style="font-size:28px;"></i><span>Ekle</span></button>
    <button class="bn-item" onclick="showView('daily', this)"><i class="fa-solid fa-calendar-day"></i><span>Günlük</span></button>
    <button class="bn-item" onclick="showView('list', this)"><i class="fa-solid fa-list"></i><span>Liste</span></button>
</nav>

<div id="modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 style="margin:0; font-size:20px;">Görev Detayı</h2>
            <div class="icon-btn" onclick="closeModal()">✕</div>
        </div>
        
        <input type="hidden" id="tId">
        
        <div class="form-group">
            <label class="form-label">Konu</label>
            <select id="tTitle" class="form-input"></select>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div class="form-group">
                <label class="form-label">Durum</label>
                <select id="tStatus" class="form-input">
                    <option value="todo">Bekliyor</option>
                    <option value="progress">İşlemde</option>
                    <option value="done">Tamamlandı</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Öncelik</label>
                <select id="tPriority" class="form-input">
                    <option value="Düşük">Düşük</option>
                    <option value="Orta">Orta</option>
                    <option value="Yüksek">Yüksek</option>
                </select>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div class="form-group">
                <label class="form-label">Tarih</label>
                <input type="date" id="tDate" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Saat</label>
                <input type="time" id="tTime" class="form-input">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Açıklama</label>
            <textarea id="tDesc" class="form-input" rows="3"></textarea>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:24px;">
            <button class="icon-btn" style="border-color:#ef4444; color:#ef4444;" onclick="delTask()"><i class="fa-solid fa-trash"></i></button>
            <button class="btn-primary" style="padding:0 32px;" onclick="saveTask()">Kaydet</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, runTransaction, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAvPpg1Qa6XF8kPV_VZXq7BE04geXLqo4s", authDomain: "it-tasks-bc974.firebaseapp.com", projectId: "it-tasks-bc974", storageBucket: "it-tasks-bc974.firebasestorage.app", messagingSenderId: "978679373454", appId: "1:978679373454:web:3ee1c689cf1ca321af33df" };
    let app, db, auth; try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) {}

    const TOPICS = ["Infact", "Rating", "Dijital Mizan", "KDS", "Mobil Uygulama", "Kullanıcı Talepleri", "Satın Alım", "RM/KKB", "Halkbank", "Denetim", "Diğer"];
    let tasks = []; let calDate = new Date(); let activeDate = new Date();

    window.initApp = () => {
        // Dropdown doldur
        const sel = document.getElementById('tTitle'); TOPICS.forEach(t=>sel.innerHTML+=`<option>${t}</option>`);
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString('tr-TR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('uName').innerText = user.email.split('@')[0];
                listenTasks();
            } else { document.getElementById('loginOverlay').style.display = 'flex'; }
        });
    }

    window.login = () => { const e = document.getElementById('email').value; const p = document.getElementById('password').value; signInWithEmailAndPassword(auth, e, p).catch(err => { if(err.code.includes('not-found')) createUserWithEmailAndPassword(auth, e, p); else alert(err.message); }); }
    window.logout = () => signOut(auth).then(()=>window.location.reload());

    function listenTasks() {
        if(!db) return;
        onSnapshot(query(collection(db, "tasks"), orderBy("code", "desc")), (snap) => {
            tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAll();
        });
    }

    function renderAll() {
        renderDashboard();
        renderKanban();
        renderDaily(activeDate);
        renderList();
    }

    // --- DASHBOARD ---
    function renderDashboard() {
        const c = {todo:0, progress:0, done:0}; 
        tasks.forEach(t => { if(c[t.status]!==undefined) c[t.status]++ });
        document.getElementById('dTotal').innerText = tasks.length;
        document.getElementById('dTodo').innerText = c.todo;
        document.getElementById('dProg').innerText = c.progress;
        document.getElementById('dDone').innerText = c.done;
        
        if(window.chartInstance) window.chartInstance.destroy();
        const ctx = document.getElementById('chartStatus').getContext('2d');
        window.chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Bekleyen', 'İşlemde', 'Biten'],
                datasets: [{ label:'İş', data:[c.todo, c.progress, c.done], backgroundColor:['#EA580C','#2563EB','#16A34A'], borderRadius:6 }]
            },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, grid:{color:'#e5e7eb'}}, x:{grid:{display:false}}} }
        });
    }

    // --- KANBAN ---
    function renderKanban() {
        const cols = { todo: document.getElementById('col-todo'), progress: document.getElementById('col-progress'), done: document.getElementById('col-done') };
        Object.values(cols).forEach(e => e.innerHTML = '');
        const cnt = {todo:0, progress:0, done:0};
        
        tasks.forEach(t => {
            if(cols[t.status]) {
                cnt[t.status]++;
                const pClass = `kc-p-${t.priority}`;
                cols[t.status].innerHTML += `
                <div class="kanban-card ${pClass}" onclick="openModal('${t.id}')">
                    <span class="k-tag">${t.code}</span>
                    <div class="k-title">${t.title}</div>
                    <div class="k-footer">
                        <span><i class="fa-regular fa-clock"></i> ${t.date||'--'}</span>
                        <div class="avatar" style="width:24px; height:24px; font-size:10px;">CK</div>
                    </div>
                </div>`;
            }
        });
        document.getElementById('k-todo-cnt').innerText = cnt.todo;
        document.getElementById('k-prog-cnt').innerText = cnt.progress;
        document.getElementById('k-done-cnt').innerText = cnt.done;

        // Desktop Sortable
        if(window.innerWidth > 768) {
            ['col-todo','col-progress','col-done'].forEach(id => {
                new Sortable(document.getElementById(id), { group:'kanban', animation:150, onEnd: async(e)=>{
                    await updateDoc(doc(db,"tasks",e.item.getAttribute('onclick').split("'")[1]), {status:e.to.getAttribute('data-status')});
                }});
            });
        }
    }

    // --- DAILY & CALENDAR ---
    function renderDaily(dateObj) {
        // Render Calendar Grid
        const y = dateObj.getFullYear(), m = dateObj.getMonth();
        document.getElementById('calTitle').innerText = dateObj.toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
        const g = document.getElementById('mainCalendar'); g.innerHTML = '';
        
        const fDay = new Date(y, m, 1).getDay(); const off = fDay===0?6:fDay-1;
        const days = new Date(y, m+1, 0).getDate();
        
        for(let i=0; i<off; i++) g.innerHTML += '<div></div>';
        
        const todayStr = new Date().toDateString();
        const activeStr = activeDate.toDateString();
        
        for(let i=1; i<=days; i++) {
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const hasTask = tasks.some(t => t.date === dStr);
            const isToday = new Date(y,m,i).toDateString() === todayStr;
            const isSel = new Date(y,m,i).toDateString() === activeStr;
            
            const div = document.createElement('div');
            div.className = `cal-cell ${isToday?'today':''} ${hasTask?'has-task':''}`;
            if(isSel && !isToday) div.style.background = '#DBEAFE'; // Light Blue Selection
            div.innerText = i;
            div.onclick = () => { activeDate = new Date(y, m, i); renderDaily(activeDate); };
            g.appendChild(div);
        }

        // Render List
        const dateStrISO = `${activeDate.getFullYear()}-${String(activeDate.getMonth()+1).padStart(2,'0')}-${String(activeDate.getDate()).padStart(2,'0')}`;
        document.getElementById('selectedDateDisp').innerText = activeDate.toLocaleDateString('tr-TR', {day:'numeric', month:'long'});
        
        const dayTasks = tasks.filter(t => t.date === dateStrISO);
        document.getElementById('dayTotal').innerText = dayTasks.length;
        
        const list = document.getElementById('dailyTaskList'); list.innerHTML = '';
        if(dayTasks.length===0) list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">Görev bulunamadı.</div>';
        
        dayTasks.forEach(t => {
            const stColor = t.status==='done'?'var(--tag-done-text)':(t.status==='progress'?'var(--tag-norm-text)':'var(--tag-critical-text)');
            const stBg = t.status==='done'?'var(--tag-done-bg)':(t.status==='progress'?'var(--tag-norm-bg)':'var(--tag-critical-bg)');
            list.innerHTML += `
            <div class="daily-task-item" onclick="openModal('${t.id}')">
                <div class="dti-time">${t.time||'--:--'}</div>
                <div class="dti-content">
                    <div class="dti-title">${t.title}</div>
                    <div class="dti-sub">${t.desc||''}</div>
                </div>
                <div class="dti-status" style="background:${stBg}; color:${stColor}">${t.status}</div>
            </div>`;
        });
    }
    window.navCal = (d) => { activeDate.setMonth(activeDate.getMonth()+d); renderDaily(activeDate); }
    window.newTaskForDate = () => { document.getElementById('tId').value=''; document.getElementById('tTitle').value=''; 
        const ds = `${activeDate.getFullYear()}-${String(activeDate.getMonth()+1).padStart(2,'0')}-${String(activeDate.getDate()).padStart(2,'0')}`;
        document.getElementById('tDate').value = ds; document.getElementById('modal').classList.add('show');
    }

    // --- LIST VIEW ---
    window.renderList = (filter='all') => {
        const c = document.getElementById('fullListContainer'); c.innerHTML = '';
        const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
        
        let filtered = tasks.filter(t => (filter==='all' || t.status===filter) && t.title.toLowerCase().includes(search));
        
        if(filtered.length === 0) c.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary)">Kayıt yok.</div>';
        
        filtered.forEach(t => {
            c.innerHTML += `
            <div style="display:flex; justify-content:space-between; padding:16px; border-bottom:1px solid var(--border-color); align-items:center; cursor:pointer;" onclick="openModal('${t.id}')">
                <div>
                    <div style="font-weight:600; color:var(--text-primary);">${t.title}</div>
                    <div style="font-size:12px; color:var(--text-secondary);">${t.code} • ${t.date}</div>
                </div>
                <span class="k-tag">${t.status}</span>
            </div>`;
        });
    }
    document.getElementById('searchInput').addEventListener('input', ()=>window.renderList());

    // --- NAVIGATION ---
    window.showView = (v, btn) => {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.getElementById('pageTitle').innerText = (v==='dashboard'?'Genel Bakış':(v==='kanban'?'İş Panosu':(v==='daily'?'Günlük Plan':'Tüm Liste')));
        
        if(btn) {
            document.querySelectorAll('.nav-item, .bn-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        renderAll();
    }

    // --- MODAL & CRUD ---
    window.newTask = () => { document.getElementById('tId').value=''; document.getElementById('tTitle').value=''; document.getElementById('modal').classList.add('show'); }
    window.closeModal = () => document.getElementById('modal').classList.remove('show');
    
    window.openModal = (id) => {
        const t = tasks.find(x=>x.id===id);
        if(t) {
            document.getElementById('tId').value=t.id;
            document.getElementById('tTitle').value=t.title;
            document.getElementById('tStatus').value=t.status;
            document.getElementById('tPriority').value=t.priority;
            document.getElementById('tDate').value=t.date;
            document.getElementById('tTime').value=t.time||'';
            document.getElementById('tDesc').value=t.desc;
            document.getElementById('modal').classList.add('show');
        }
    }

    window.saveTask = async () => {
        const id = document.getElementById('tId').value;
        const d = {
            title: document.getElementById('tTitle').value,
            status: document.getElementById('tStatus').value,
            priority: document.getElementById('tPriority').value,
            date: document.getElementById('tDate').value,
            time: document.getElementById('tTime').value,
            desc: document.getElementById('tDesc').value
        };
        
        if(id) await updateDoc(doc(db,"tasks",id), d);
        else {
            await runTransaction(db, async(t) => {
                const ref = doc(db,"meta","counters"); const snap = await t.get(ref);
                const seq = (snap.exists()?snap.data().taskSeq:0)+1;
                t.set(ref, {taskSeq:seq}, {merge:true}); d.code = 'GRV-'+seq;
                await addDoc(collection(db,"tasks"), d);
            });
        }
        closeModal();
    }
    
    window.delTask = async () => { if(confirm('Sil?')) { await deleteDoc(doc(db,"tasks", document.getElementById('tId').value)); closeModal(); } }
    
    window.exportExcel = () => { const ws = XLSX.utils.json_to_sheet(tasks); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Tasks"); XLSX.writeFile(wb, "BT_Portal.xlsx"); }
    
    window.toggleTheme = () => { const b=document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')==='dark'?'light':'dark'); }
</script>
</body>
</html>
